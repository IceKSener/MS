import{_ as oe,g as z,r as B,e as L,f as Z,w as ae,h as x,i as re,o as a,c as u,a as l,u as m,t as k,F as q,j as N,n as r,k as Q,l as E,v as $,b as ue,m as ce,p as de,q as fe,s as he,x as ve}from"./index-f_SZIbh7.js";const D=""+new URL("../icon/del.svg",import.meta.url).href,me=""+new URL("../icon/add.svg",import.meta.url).href,W=""+new URL("../icon/chat.svg",import.meta.url).href,ge=""+new URL("../icon/submit.svg",import.meta.url).href,pe={class:"area"},_e={class:"functions"},xe=["title"],ke={class:"chats"},be=["onClick"],ye=["title"],we=["title"],Ce=["onClick"],Ee={class:"mainArea"},Ae={class:"question_bar"},Se=["title","onClick"],Ie={xmlns:"http://www.w3.org/2000/svg","xml:space":"preserve",viewBox:"0 0 1964 1963",overflow:"hidden"},Te=["id"],Be={fill:"#393C45"},qe=["title"],Ne=["onClick"],$e={key:1},Me={key:2,class:"refFiles"},Oe={class:"filesItems"},je=["title","href"],Re={class:"relQues"},Fe={class:"quesItems"},ze=["title","onClick"],Le=["onKeydown"],De={__name:"AskAnswer",setup(He){let A=z().proxy.api,g=z().proxy.config,p=z().proxy.screen;const i=B(),c=L([]);let b=null;const y=B(),S=B(),H=Z(()=>i.value.messages.every(s=>s.fold)),f=B(!1);ae(c,()=>{f.value=c.length<=0?!1:f.value});const U=Z(()=>{const s=i.value;if(s.status!="ready")return!0;const t=s.messages;return t.length>0&&t[t.length-1].status=="unfinished"});window.chats=c;function X(){const s=c.map(e=>e.session_id);function t(){let e=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(h){let v=(e+Math.random()*16)%16|0;return e=Math.floor(e/16),(h=="x"?v:v&3|8).toString(16)})}let n=t();for(;s.indexOf(n)>=0;)n=t();return b=L({title:"",messages:[],session_id:n,input:"",rel_ques:[],status:"ready"}),console.log(b),b}x.on("clearChats",()=>{ee()}),i.value=X();function G(s){i.value=s,s.status!="ready",p.type=="ver"&&(f.value=!1)}function I(s,t=!1){function n(){let e=c.indexOf(s);c[e]==i.value&&(i.value=b),s.messages.forEach(o=>{o.controller.abort()}),c.splice(e,1)}t?x.emit("dialog",{text:"确定删除该会话吗？",onYes(){n()}}):n()}function ee(s=!1){function t(){c.forEach(n=>I(n))}s?x.emit("dialog",{text:"确定清空所有会话吗？",onYes(){t()}}):t()}function M(s=void 0){s!=null&&(i.value.input=s,y.value.value=s),y.value.style.height="auto",y.value.style.height=y.value.scrollHeight+"px"}function J(s){s.preventDefault();const t=i.value,n=t.messages;n.length>0&&n[n.length-1].status=="unfinished"||P(t.input)&&(M(""),t.rel_ques.length=0)}function P(s,t=void 0,n=i.value){if(!g.loginStatus.isLogged)return x.emit("startLogin",{msg:"请登录后使用",err:!0}),!1;if(s=s.trim(),s.length<=0)return!1;let e=L({question:s,id:null,text:"",status:"unfinished",controller:new AbortController,fold:!1,ref_files:[]}),o="";t?K(n,t,e):n.messages.push(e),c.indexOf(n)<0&&(n.title=s,c.push(n),X());let h=[];h.push({role:"user",content:s}),fetch(A.path+"/v1/chat/completions",{signal:e.controller.signal,method:"POST",headers:{Authorization:"Bearer "+g.loginStatus.userinfo.access_token,"Content-Type":"application/json"},body:JSON.stringify({session_id:n.session_id,model:"qwen2.5-math-7b-instruct",messages:h,max_tokens:1e3,temperature:1})}).then(_=>{if(_.status===401)fetch(A.path+"/api/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:g.loginStatus.userinfo.refresh_token})}).then(d=>d.json()).then(d=>{if(d.code!=200)throw Error(d.code+": "+d.message);g.loginStatus.userinfo.access_token=d.data.access_token,P(s,e)}).catch(d=>{o="[登录过期，请重新登录]",e.status="error",x.emit("logout"),x.emit("startLogin",{msg:"登录过期，请重新登录",err:!0}),console.error(d)});else if(!_.ok)throw Error(_.status+": "+_.statusText);const ne=_.body.getReader(),le=new TextDecoder;let w="";function Y(){ne.read().then(({done:d,value:ie})=>{if(d){e.status="finished";return}w+=le.decode(ie,{stream:!0});let R=0,C=0;for(;C=w.indexOf("}",R)+1,C!=0;)try{let F=JSON.parse(w.substring(0,C));if(e.id=F.id,F.final){e.status="finished",te(e,n);return}o+=F.choices[0].message.content,w=w.substring(C),R=0}catch{R=C}Y()}).catch(d=>{if(d.name==="AbortError"){o="",e.status="finished";return}o+="[解析异常]",e.status="error",console.error(d)})}Y()}).catch(_=>{if(_.name==="AbortError"){o="",e.status="finished";return}o+="[请求异常]",e.status="error",console.error(_)});let v=0,V=0,T=0,O="",j=0;return g.settings.printByWord?(V=setInterval(()=>{if(v==1&&setTimeout(()=>S.value.scrollTo(0,Number.MAX_SAFE_INTEGER),500),v<o.length)O+=o.at(v),++v;else if(e.status!="unfinished"){if(v<o.length){j=0;return}else if(j<5){j++;return}clearInterval(V),e.text=O,clearInterval(T)}},1e3/g.settings.charPerSecond),T=setInterval(()=>{e.text=O},1e3/20)):T=setInterval(()=>{e.text=o,v==1&&o.length>0&&setTimeout(()=>S.value.scrollTo(0,Number.MAX_SAFE_INTEGER),500),v++,e.status!="unfinished"&&(e.text=o,clearInterval(T))},1e3/20),!0}function te(s,t=i.value){fetch(A.path+"/v1/related_questions",{signal:s.controller.signal,method:"POST",headers:{Authorization:"Bearer "+g.loginStatus.userinfo.access_token,"Content-Type":"application/json"},body:JSON.stringify({question:s.question})}).then(n=>{if(n.status!=200)throw Error(n.status+": "+n.statusText);return n.json()}).then(n=>{n.status=="success"&&(t.rel_ques=n.related_questions||[],setTimeout(()=>S.value.scrollTo(0,Number.MAX_SAFE_INTEGER),500))}).catch(n=>{console.error(n)}),fetch(A.path+"/v1/reference_files?question_id="+s.id,{signal:s.controller.signal,method:"GET",headers:{Authorization:"Bearer "+g.loginStatus.userinfo.access_token}}).then(n=>{if(n.status!=200)throw Error(n.status+": "+n.statusText);return n.json()}).then(n=>{n.status=="success"&&(s.ref_files=n.reference_files)}).catch(n=>{console.error(n)})}function K(s,t,n=void 0){t.controller.abort();let e=s.messages.indexOf(t);if(n)s.messages.splice(e,1,n);else{if(s.messages.length==1){I(s);return}s.messages[e].id,s.messages.splice(e,1)}return e}function se(){H.value?i.value.messages.forEach(s=>{s.fold=!1}):i.value.messages.forEach(s=>{s.fold=!0})}return(s,t)=>{const n=re("Markdown");return a(),u("div",pe,[l("div",{class:r(["chatsBar",m(p).type,{show:c.length>0,active:f.value}])},[l("div",_e,[m(p).type=="hor"?(a(),u("div",{key:0,class:"toggleBar buttonEffect",onClick:t[0]||(t[0]=e=>f.value=!f.value),title:f.value?"收回":"展开"},k(f.value?"<":">"),9,xe)):(a(),u("div",{key:1,class:"toggleBar buttonEffect",onClick:t[1]||(t[1]=e=>f.value=!1),title:"关闭"},t[8]||(t[8]=[l("img",{src:D,alt:" X"},null,-1)]))),l("div",{class:"addButton buttonEffect",onClick:t[2]||(t[2]=e=>G(m(b))),title:"创建新会话"},t[9]||(t[9]=[l("img",{src:me,alt:"add"},null,-1),l("div",null,"创建新会话",-1)]))]),l("div",ke,[(a(!0),u(q,null,N(c,e=>(a(),u("div",{class:r(["buttonEffect","chatItem",{active:i.value==e}]),onClick:o=>G(e)},[l("img",{src:W,alt:"C",class:"chatIcon",title:e.title},null,8,ye),l("span",{title:e.title},k(e.title),9,we),l("img",{src:D,alt:"X",class:"delButton buttonEffect",onClick:Q(o=>I(e,!0),["stop"])},null,8,Ce)],10,be))),256))])],2),E(l("img",{src:W,alt:"对话",class:"floatChat buttonEffect",onClick:t[3]||(t[3]=e=>f.value=!f.value)},null,512),[[$,m(p).type=="ver"&&c.length>0]]),l("div",Ee,[l("div",{class:r(["startArea",{hasContent:i.value.messages.length>0}])},t[10]||(t[10]=[l("div",{class:"title"},[l("img",{src:ue,alt:"MathSolve"}),l("span",null,"你的数学解题助手")],-1),l("div",{class:"subtitle"},"一键求解，轻松解决你的数学烦恼",-1)]),2),l("div",{class:r(["answersArea",{hasContent:i.value.messages.length>0}])},[l("div",{class:r(["toolbar",m(p).type])},[l("div",{onClick:t[4]||(t[4]=e=>I(i.value,!0)),class:"buttonEffect"},"删除会话"),l("div",{onClick:t[5]||(t[5]=e=>se()),class:"buttonEffect"},"全部"+k(H.value?"展开":"折叠"),1)],2),l("div",{class:r(["answers",m(p).type]),ref_key:"answers",ref:S},[(a(!0),u(q,null,N(i.value.messages,(e,o)=>(a(),u("div",{class:r(["msg",e.status])},[l("div",Ae,[l("div",{class:r(["foldButton","buttonEffect",{folded:e.fold}]),title:e.fold?"展开":"折叠",onClick:h=>e.fold=!e.fold},[(a(),u("svg",Ie,[l("defs",null,[l("mask",{id:"mask"+o},t[11]||(t[11]=[l("rect",{width:"100%",height:"100%",fill:"white"},null,-1),l("path",{class:"turn",stroke:"black","stroke-linejoin":"round","stroke-miterlimit":"10","stroke-width":"150",d:"m982 926 632 791h-319l-313-391-313 391H350Z"},null,-1)]),8,Te)]),l("g",Be,[l("path",{d:"M287 1174h1390v203H287zM287 786h1390v203H287zM287 398h1390v203H287z",style:ce(`mask:url(#mask${o})`)},null,4),t[12]||(t[12]=l("path",{class:"turn",d:"m982 982 562 702h-284l-278-347-278 347H420Z"},null,-1))])]))],10,Se),l("div",{class:r(["question",{folded:e.fold,thinking:e.fold&&e.status==="unfinished"}]),title:e.question},k(e.question),11,qe),l("img",{class:"delButton buttonEffect",src:D,title:"删除",onClick:h=>K(i.value,e)},null,8,Ne)]),E(l("br",null,null,512),[[$,!e.fold]]),E(l("div",{class:r({foldable:!0,thinking:e.status==="unfinished"}),style:{display:"flex"}},[e.text.length>0?(a(),de(n,{key:0,md:e.text,theme:m(g).settings.theme},null,8,["md","theme"])):(a(),u("div",$e," ... ")),e.ref_files.length>0?(a(),u("div",Me,[t[13]||(t[13]=l("div",{class:"filesTitle"},"... 参考文档 ...",-1)),l("div",Oe,[(a(!0),u(q,null,N(e.ref_files,h=>(a(),u("a",{class:"filesItem",title:h.name,href:h.url,target:"_blank"},k(h.name),9,je))),256))])])):fe("",!0)],2),[[$,!e.fold]])],2))),256)),E(l("div",Re,[t[14]||(t[14]=l("div",{class:"quesTitle"},"继续提问：",-1)),l("div",Fe,[(a(!0),u(q,null,N(i.value.rel_ques,e=>(a(),u("div",{class:"quesItem buttonEffect",title:e,onClick:o=>M(e)},k(e),9,ze))),256))])],512),[[$,i.value.rel_ques.length>0]])],2)],2),l("div",{class:r(["requestArea",{hasContent:i.value.messages.length>0}])},[l("div",{class:r(["request",m(p).type])},[E(l("textarea",{contenteditable:"true",class:r(["requestbox",m(p).type]),"onUpdate:modelValue":t[6]||(t[6]=e=>i.value.input=e),placeholder:"输入问题，多行输入使用Shift+Enter换行",onKeydown:ve(Q(J,["exact"]),["enter"]),onInput:t[7]||(t[7]=e=>M()),ref_key:"inputTextarea",ref:y},null,42,Le),[[he,i.value.input]]),l("div",{class:r(["submitRow",m(p).type])},[l("img",{class:r(["submit",{buttonEffect:!U.value,disable:U.value}]),src:ge,alt:"提问",onClick:J},null,2)],2)],2)],2)])])}}},Xe=oe(De,[["__scopeId","data-v-b221c23d"]]);export{Xe as default};
