import{_ as O,g as A,r as d,e as I,C,o as _,c as M,a as t,d as h,m as L,k as u,v as g,l as x,u as c,h as n,n as P}from"./index-DRuE_ApQ.js";const V={class:"class"},N={class:"item image"},F={class:"imageArea"},W=["src"],X={class:"drag"},Y={class:"item text"},J={class:"submitLine"},Z={class:"class"},H={class:"item text"},q={class:"item text"},G={class:"submitLine"},K={class:"class"},D=16,Q={__name:"UserInfo",setup(ee){let a=A().proxy.config,E=A().proxy.screen;d({});const y=d(),i=I({name:a.loginStatus.userinfo.name,photo:a.loginStatus.userinfo.photo,pswd1:"",pswd2:""});let l=null,f=0;const m=d(!1),p=d(!1);function z(s){f++,s.target==s.currentTarget&&(m.value=!0)}function B(s){f--;const e=s.currentTarget.getBoundingClientRect();(s.clientX<=e.left||s.clientX>=e.right||s.clientY<=e.top||s.clientY>=e.bottom)&&(f=0),f===0&&(m.value=!1)}function R(s){f=0,m.value=!1,l=s.dataTransfer.files[0],l.type.startsWith("image")&&(URL.revokeObjectURL(i.photo),i.photo=URL.createObjectURL(l))}function $(s){l=s.target.files[0],!(!l||!l.type.startsWith("image"))&&(URL.revokeObjectURL(i.photo),i.photo=URL.createObjectURL(l))}async function b(){try{v.value=!1;let s={},e={Authorization:"Bearer "+a.loginStatus.userinfo.access_token};if(i.photo!==a.loginStatus.userinfo.photo){let T=new FormData;T.append("photo",l);let r=await fetch(api.path+"/upload_image",{method:"POST",headers:e,body:T});if(r=await r.json(),r.code===401){n.emit("refreshToken"<{onSuccess(){submit()}});return}else if(r.code!==201)throw Error(r.code?r.message:"头像上传失败");s.photo=r.data}i.name!==a.loginStatus.userinfo.name&&(s.name=i.name),s=JSON.stringify(s);let o=await fetch(api.path+"/update_info",{method:"PUT",headers:e,body:s});if(o=await o.json(),o.code===401){n.emit("refreshToken"<{onSuccess(){b()}});return}else if(o.code!==200)throw Error(o.code?o.message:"信息更新失败");n.emit("refreshUserInfo"),n.emit("dialog",{text:o.message})}catch(s){n.emit("dialog",{text:s.message}),console.error(s)}finally{v.value=!0}}const k=/^(?=.*[A-Za-z])(?=.*\d)(?=.*[@#$%^&*!])[A-Za-z\d@#$%^&*!]{8,16}$/;async function S(){try{if(i.pswd1!==i.pswd2){n.emit("dialog",{text:"两次输入的密码不一致!"});return}if(console.log(k.test(i.pswd1)),!k.test(i.pswd1)){n.emit("dialog",{text:`密码长度须为8-16个字符，至少包含1个大写字母、
1个小写字母、1个数字、1个特殊字符(@#$%^&*)`});return}w.value=!1;let s=JSON.stringify({password:i.pswd1}),e={Authorization:"Bearer "+a.loginStatus.userinfo.access_token},o=await fetch(api.path+"/change_password",{method:"PUT",headers:e,body:s});if(o=await o.json(),o.code===401){console.log("刷新"),n.emit("refreshToken"<{onSuccess(){S()}});return}else if(o.code!==200)throw Error(o.code?o.message:"密码修改失败");i.pswd1=i.pswd2="",n.emit("dialog",{text:o.message})}catch(s){n.emit("dialog",{text:s.message}),console.error(s)}finally{w.value=!0}}function j(){function s(){fetch(api.path+"/cancel_account",{method:"DELETE",headers:{Authorization:"Bearer "+a.loginStatus.userinfo.access_token}}).then(e=>e.json()).then(e=>{if(e.code===401){n.emit("refreshToken",{onSuccess:s});return}else if(e.code!==200)throw Error(e.code?e.message:"注销失败!");n.emit("dialog",{text:e.message}),n.emit("logout")}).catch(e=>{n.emit("dialog",{text:e.message}),console.error(e)})}n.emit("dialog",{text:"确认要注销账号吗？",onYes(){s()}})}C(()=>{i.photo=a.loginStatus.userinfo.photo,i.name=a.loginStatus.userinfo.name});let U=d(!1),v=d(!0),w=d(!0);return C(()=>U.value=i.name!==a.loginStatus.userinfo.name||i.photo!==a.loginStatus.userinfo.photo),(s,e)=>(_(),M("div",{class:P(["area",c(E).type])},[t("div",V,[e[13]||(e[13]=h("基本信息 ")),t("div",N,[e[11]||(e[11]=t("div",{class:"text"},"我的头像:",-1)),t("div",F,[t("img",{class:"image",src:i.photo},null,8,W),t("div",{class:"input",onDragenter:z,onDragover:e[1]||(e[1]=L(()=>{},["prevent"])),onDrop:L(R,["prevent"]),onDragleave:B,onMouseenter:e[2]||(e[2]=o=>p.value=!0),onMouseleave:e[3]||(e[3]=o=>p.value=!1)},[u(t("div",{class:"click",onClick:e[0]||(e[0]=o=>y.value.click())},[t("input",{type:"file",style:{display:"none"},ref_key:"imageSelector",ref:y,accept:"image/*",onChange:$},null,544),e[9]||(e[9]=t("svg",{xmlns:"http://www.w3.org/2000/svg",width:"200",height:"200"},[t("text",{x:"100",y:"100",fill:"none",stroke:"#000","stroke-width":"4","font-size":"20",style:{"text-anchor":"middle","dominant-baseline":"middle"}},"点击上传文件"),t("text",{x:"100",y:"100",fill:"#fff","font-size":"20",style:{"text-anchor":"middle","dominant-baseline":"middle"}},"点击上传文件")],-1))],512),[[g,!m.value&&p.value]]),u(t("div",X,e[10]||(e[10]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",width:"200",height:"200"},[t("text",{x:"100",y:"100",fill:"none",stroke:"#000","stroke-width":"4","font-size":"20",style:{"text-anchor":"middle","dominant-baseline":"middle"}},"拖拽上传文件"),t("text",{x:"100",y:"100",fill:"#fff","font-size":"20",style:{"text-anchor":"middle","dominant-baseline":"middle"}},"拖拽上传文件")],-1)]),512),[[g,m.value]])],32)])]),t("div",Y,[e[12]||(e[12]=t("div",{class:"text"},"我的昵称:",-1)),u(t("input",{type:"text",class:"input","onUpdate:modelValue":e[4]||(e[4]=o=>i.name=o)},null,512),[[x,i.name]])]),t("div",J,[u(t("div",{class:"submitButton",onClick:b},"提交",512),[[g,c(U)&&c(v)]])])]),t("div",Z,[e[16]||(e[16]=h("修改密码 ")),t("div",H,[e[14]||(e[14]=t("div",{class:"text"},"新密码:",-1)),u(t("input",{type:"password",maxlength:D,class:"input","onUpdate:modelValue":e[5]||(e[5]=o=>i.pswd1=o)},null,512),[[x,i.pswd1]])]),t("div",q,[e[15]||(e[15]=t("div",{class:"text"},"确认新密码:",-1)),u(t("input",{type:"password",maxlength:D,class:"input","onUpdate:modelValue":e[6]||(e[6]=o=>i.pswd2=o)},null,512),[[x,i.pswd2]])]),t("div",G,[u(t("div",{class:"submitButton",onClick:S},"修改",512),[[g,c(w)]])])]),t("div",K,[e[19]||(e[19]=h("其他功能 ")),t("div",{class:"item button buttonEffect",onClick:e[7]||(e[7]=o=>c(n).emit("delAllChats"))},e[17]||(e[17]=[t("div",{class:"text"},"删除所有会话",-1)])),t("div",{class:"item button buttonEffect",onClick:e[8]||(e[8]=o=>j())},e[18]||(e[18]=[t("div",{class:"text"},"注销账号",-1)]))])],2))}},se=O(Q,[["__scopeId","data-v-b4c75cfb"]]);export{se as default};
