import{_ as be,g as ee,r as $,e as O,f as me,w as Ce,h as d,i as Se,o as f,c as h,a as o,u as m,t as B,F as H,j as J,n as v,k as C,v as q,l as ve,m as D,p as Ae,q as ge,s as Te,d as Be,b as qe,x as V,y as Ie,z as Me,A as pe}from"./index-DRuE_ApQ.js";const te=""+new URL("../icon/del.svg",import.meta.url).href,Re=""+new URL("../icon/add.svg",import.meta.url).href,xe=""+new URL("../icon/chat.svg",import.meta.url).href,$e=""+new URL("../icon/edit.svg",import.meta.url).href,Le=""+new URL("../icon/loading.svg",import.meta.url).href,Ne=""+new URL("../icon/copy.svg",import.meta.url).href,Ue=""+new URL("../icon/submit.svg",import.meta.url).href,je={class:"area"},Oe={class:"functions"},De=["title"],Fe={class:"chats"},ze=["title","onClick"],Ge=["onBlur","onKeyup"],He=["onClick"],Je={class:"mainArea"},Ve={class:"questionBar"},Pe=["title","onClick"],Xe={xmlns:"http://www.w3.org/2000/svg","xml:space":"preserve",viewBox:"0 0 1964 1963",overflow:"hidden"},Ke=["id"],Qe={fill:"#393C45"},Ye=["title"],We=["onClick"],Ze=["onClick"],et={key:1},tt={key:2,class:"refFiles"},st=["onClick"],nt=["title","href"],lt={class:"relQues"},it={class:"quesItems"},ot=["title","onClick"],rt=["onKeydown"],at={__name:"AskAnswer",setup(ut){let p=ee().proxy.api,x=ee().proxy.config,k=ee().proxy.screen;const se=Blob&&URL.createObjectURL&&URL.revokeObjectURL,a=$(),c=O([]);let S=null;const L=$(),R=$(),ne=$();window.currentChat=a;const le=me(()=>a.value.messages.every(l=>l.fold)),_=$(!1),P=$(!1);let X=null,ie=null;window.addEventListener("mouseup",()=>P.value=!1),Ce(c,()=>{_.value=c.length<=0?!1:_.value});const oe=me(()=>{const l=a.value;if(l.status!="ready")return!0;const e=l.messages;return e.length>0&&e[e.length-1].status=="unfinished"});window.chats=c;let A=()=>({Authorization:"Bearer "+x.loginStatus.userinfo.access_token,"Content-Type":"application/json"});function K(){const l=c.map(t=>t.session_id);function e(){let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(i){let r=(t+Math.random()*16)%16|0;return t=Math.floor(t/16),(i=="x"?r:r&3|8).toString(16)})}let s=e();for(;l.indexOf(s)>=0;)s=e();return S=O({title:"",messages:[],session_id:s,input:"",rel_ques:[],status:"ready",editing:!1}),S}d.on("loadChats",()=>{de()}),d.on("clearChats",()=>{c.length=0,a.value=K()}),d.on("delAllChats",()=>{_e(!0)}),a.value=K();function re(){c.sort((l,e)=>e.timestamp-l.timestamp)}function ae(l,e=!0){if(a.value=l,l.status=="unload"){let s=function(n){n.forEach(i=>{l.messages.push(O({question:i.question,id:i.question_id,text:i.answer,status:"finished",controller:{abort(){}},fold:!1,ref_files:[],ref_show:!1}))}),l.status="ready",setTimeout(()=>R.value.scrollTo(0,Number.MAX_SAFE_INTEGER),300)},t=A();fetch(p.path+"/get_qas?session_id="+l.session_id,{method:"GET",headers:t}).then(n=>n.json()).then(n=>{if(n.code===401){d.emit("refreshToken",{onSuccess(i){t.Authorization="Bearer "+i,fetch(p.path+"/get_qas?session_id="+l.session_id,{method:"GET",headers:t}).then(r=>r.json()).then(r=>{if(r.code!==200)throw Error(r.code?r.message:"会话加载失败");s(r.data)}).catch(r=>{d.emit("dialog",{text:r.message}),console.error(r)})}});return}else if(n.code!==200)throw Error(n.code?n.message:"会话加载失败");s(n.data)}).catch(n=>{d.emit("dialog",{text:n.message}),console.error(n)})}k.type=="ver"&&e&&(_.value=!1),setTimeout(()=>R.value.scrollTo(0,Number.MAX_SAFE_INTEGER),300)}function ue(l,e=!1){function s(){let t=c.indexOf(l);c[t]==a.value&&(a.value=S),l.messages.forEach(n=>{n.controller.abort()}),c.splice(t,1),fetch(p.path+"/delete_session/"+l.session_id,{method:"DELETE",headers:A()})}e&&x.settings.comfBefDelSess?d.emit("dialog",{text:"确定删除该会话吗？",onYes(t){x.settings.comfBefDelSess=t,s()},checkText:"每次删除都提示确认",checkVal:!0}):s()}function _e(l=!1){function e(){fetch(p.path+"/delete_all_sessions",{method:"DELETE",headers:A()}),c.length=0,a.value=S}l?d.emit("dialog",{text:"确定清空所有会话吗？",onYes(){e()}}):e()}function de(){function l(s){let t=!1,n=[];if(c.length=0,s.forEach(i=>{c.push({title:i.name,session_id:i.session_id,timestamp:i.timestamp,messages:[],rel_ques:[],input:"",status:"unload",editing:!1}),n.push(i.session_id),i.session_id==S.session_id&&(t=!0)}),t){let i=function(){let E=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(y){let M=(E+Math.random()*16)%16|0;return E=Math.floor(E/16),(y=="x"?M:M&3|8).toString(16)})},r=i();for(;n.indexOf(r)>=0;)r=i();S.session_id=r}a.value=S}if(!x.loginStatus.isLogged)return;let e=A();fetch(p.path+"/get_sessions",{method:"GET",headers:e}).then(s=>s.json()).then(s=>{if(s.code===401)d.emit("refreshToken",{onSuccess(t){e.Authorization="Bearer "+t,fetch(p.path+"/get_sessions",{method:"GET",headers:e}).then(n=>n.json()).then(n=>{if(n.code!==200)throw Error(n.code?n.message:"会话加载失败，请刷新重试");l(n.data||[])}).catch(n=>{d.emit("dialog",{text:n.message}),console.error(n)})}});else{if(s.code!==200)throw Error(s.code?s.message:"会话加载失败，请刷新重试");l(s.data||[])}}).catch(s=>{d.emit("dialog",{text:s.message}),console.error(s)})}let I=O("");function Q(l,e=void 0){if(e!==void 0){if(l.editing=!1,e&&l.title!=e){l.title=e;let s=JSON.stringify({session_id:l.session_id,name:e});fetch(p.path+"/rename_session",{method:"PUT",headers:A(),body:s})}}else I=l.title,l.editing=!0,pe(()=>{ie.getElementsByClassName("input")[0].focus()})}function ye(l,e){let s=l.target,t=s.getClientRects()[0],n=ne.value;n.style.top="",n.style.left="",n.style.bottom="",n.style.right="",k.type=="hor"?(n.style.top=t.bottom+"px",n.style.left=t.left+"px"):(n.style.top=t.top+"px",n.style.right=`calc(100% - ${t.right}px)`),X=e,ie=s.parentElement,P.value=!0}function Y(l=void 0){l!=null&&(a.value.input=l,L.value.value=l),L.value.style.height="auto",L.value.style.height=L.value.scrollHeight+"px"}async function fe(l){l.preventDefault();const e=a.value,s=e.messages;s.length>0&&s[s.length-1].status=="unfinished"||await W(e.input)&&(Y(""),e.rel_ques.length=0)}async function W(l,e=void 0,s=a.value){if(!x.loginStatus.isLogged)return d.emit("startLogin",{msg:"请登录后使用",err:!0}),!1;if(l=l.trim(),l.length<=0)return!1;let t=A(),n;try{n=JSON.parse(p.reqBodyArg)}catch{d.emit("dialog",{text:"请求体参数解析错误，请检测是否是正确的json"});return}if(c.indexOf(s)<0){s.title=l,s.timestamp=new Date().getTime().toFixed(),s.status="prepost";try{let u=JSON.stringify({session_id:s.session_id,name:s.title}),w=await fetch(p.path+"/add_session",{method:"POST",headers:t,body:u});if(w=await w.json(),w.code===401)return d.emit("refreshToken",{onSuccess(){W(l,void 0,s)},onFail(){s.status="ready"}}),!0;if(w.code!==201)throw Error(w.code?w.message:"会话创建失败，请刷新重试")}catch(u){return d.emit("dialog",{text:u.message}),console.error(u),s.status="ready",!1}s.status="ready",c.push(s),re(),K()}let i=O({question:l,id:null,text:"",status:"unfinished",controller:new AbortController,fold:!1,ref_files:[],ref_show:!1}),r="";e?ce(s,e,i):s.messages.push(i);let E=[];E.push({role:"user",content:l}),n.messages=n.messages||E,n.session_id=n.session_id||s.session_id,n.model=n.model||"qwen2.5-math-7b-instruct",fetch(p.path+"/v1/chat/completions",{signal:i.controller.signal,method:"POST",headers:t,body:JSON.stringify(n)}).then(u=>{if(u.status===401){d.emit("refreshToken",{onSuccess(){W(l,i,s)},onFail(){r="[登录过期，请重新登录]",i.status="error"}});return}else if(!u.ok)throw Error(u.status+": "+u.statusText);const w=u.body.getReader(),F=new TextDecoder;let b="";function U(){w.read().then(({done:T,value:z})=>{if(T){i.status="finished";return}b+=F.decode(z,{stream:!0});let Z=0,j=0;for(;j=b.indexOf("}",Z)+1,j!=0;)try{let G=JSON.parse(b.substring(0,j));if(i.id=G.id,G.final){s.timestamp=G.created,re(),i.status="finished",we(i,s);return}r+=G.choices[0].message.content,b=b.substring(j),Z=0}catch{Z=j}U()}).catch(T=>{if(T.name==="AbortError"){r="",i.status="finished";return}r+="[解析异常]",i.status="error",console.error(T)})}U()}).catch(u=>{if(u.name==="AbortError"){r="",i.status="finished";return}r+="[请求异常]",i.status="error",console.error(u)});let g=0,y=0,M="";const N=20;if(x.settings.printByWord){let z=function(){i.text!=M&&(i.text=M),pe(()=>{y!==null&&(y=setTimeout(z,1e3/N))})},u="",w=!0;const F=1/N*x.settings.charPerSecond;let b=0,U=0,T=0;U=setInterval(()=>{if(g>=1&&w&&(setTimeout(()=>R.value.scrollTo(0,Number.MAX_SAFE_INTEGER),500),w=!1),g<r.length)u=r.substring(g,g+F+b),M+=u,g+=u.length,b=(F+b)%1;else if(i.status!="unfinished"){if(g<r.length){T=0;return}else if(T<5){T++;return}clearInterval(U),i.text=M,clearInterval(y),y=null}},1e3/N),y=setTimeout(z,1e3/N)}else y=setInterval(()=>{i.text!=r&&(i.text=r,g++,g==1&&r.length>0&&setTimeout(()=>R.value.scrollTo(0,Number.MAX_SAFE_INTEGER),500)),i.status!="unfinished"&&(i.text=r,clearInterval(y))},1e3/N);return!0}function we(l,e=a.value){fetch(p.path+"/v1/related_questions",{signal:l.controller.signal,method:"POST",headers:A(),body:JSON.stringify({question:l.question})}).then(s=>{if(s.status!=200)throw Error(s.status+": "+s.statusText);return s.json()}).then(s=>{s.status=="success"&&(e.rel_ques=s.related_questions||[],setTimeout(()=>R.value.scrollTo(0,Number.MAX_SAFE_INTEGER),500))}).catch(s=>{console.error(s)}),fetch(p.path+"/v1/reference_files?question_id="+l.id,{signal:l.controller.signal,method:"GET",headers:{Authorization:"Bearer "+x.loginStatus.userinfo.access_token}}).then(s=>{if(s.status!=200)throw Error(s.status+": "+s.statusText);return s.json()}).then(s=>{s.status=="success"&&(l.ref_files=s.reference_files)}).catch(s=>{console.error(s)})}function ce(l,e,s=void 0,t=!1){function n(i,r,E=void 0){r.controller.abort();let g=i.messages.indexOf(r);if(E)i.messages.splice(g,1,E);else{if(i.messages.length==1){ue(i);return}if(r.status!="error"){let y=JSON.stringify({session_id:i.session_id,question_id:i.messages[g].id});fetch(p.path+"/delete_qa",{method:"DELETE",body:y,headers:A()})}i.messages.splice(g,1)}return g}t&&x.settings.comfBefDelQues&&e.status!="error"?d.emit("dialog",{text:"确认要删除该轮提问？",onYes(i){x.settings.comfBefDelQues=i,n(l,e,s)},checkText:"每次删除都提示确认",checkVal:!0}):n(l,e,s)}function ke(){le.value?a.value.messages.forEach(l=>{l.fold=!1}):a.value.messages.forEach(l=>{l.fold=!0})}async function Ee(l){l&&(await navigator.clipboard.writeText(l),d.emit("dialog",{text:"复制成功"}))}function he(l,e){if(l.messages.length<=0)return;let s=null,t="";if(e==="markdown")t=".md",s="",l.messages.forEach(n=>{n.status=="finished"&&(s+=`**${n.question}**

`,s+=n.text+`

`,n.ref_files.length>0&&(s+="`参考文档`\n\n",n.ref_files.forEach(i=>{s+=`#### [*${i.name}*](${i.url})

`})),s+=`---

`)});else if(e==="json"){t=".json";let n=l.messages.filter(r=>r.status=="finished").map(r=>({question:r.question,question_id:r.id,answer:r.text,timestamp:r.timestamp,reference_files:r.ref_files})),i={name:l.title,session_id:l.session_id,questions:n};s=JSON.stringify(i)}if(s){let n=document.createElement("a");s=new Blob([s]);let i=URL.createObjectURL(s);n.href=i,n.download=`${l.session_id}${t}`,n.click(),URL.revokeObjectURL(i)}}return de(),(l,e)=>{const s=Se("Markdown");return f(),h("div",je,[o("div",{class:v(["chatsBar",m(k).type,{show:c.length>0,active:_.value}])},[o("div",Oe,[m(k).type=="hor"?(f(),h("div",{key:0,class:"toggleBar buttonEffect",onClick:e[0]||(e[0]=t=>_.value=!_.value),title:_.value?"收回":"展开"},B(_.value?"<":">"),9,De)):(f(),h("div",{key:1,class:"toggleBar buttonEffect",onClick:e[1]||(e[1]=t=>_.value=!1),title:"关闭"},e[13]||(e[13]=[o("img",{src:te,alt:" X"},null,-1)]))),o("div",{class:"addButton buttonEffect",onClick:e[2]||(e[2]=t=>ae(m(S))),title:"创建新会话"},e[14]||(e[14]=[o("img",{src:Re,alt:"add"},null,-1),o("div",null,"创建新会话",-1)]))]),o("div",Fe,[(f(!0),h(H,null,J(c,t=>(f(),h("div",{key:t.timestamp,class:v(["chatItem",{buttonEffect:!t.editing,active:a.value==t}]),title:t.title,onClick:n=>ae(t)},[e[15]||(e[15]=o("img",{src:xe,alt:"C",class:"chatIcon"},null,-1)),C(o("span",{class:"text"},B(t.title),513),[[q,!t.editing]]),C(o("input",{type:"text",class:"input",onClick:e[3]||(e[3]=D(()=>{},["stop"])),"onUpdate:modelValue":e[4]||(e[4]=n=>Ae(I)?I.value=n:I=n),onBlur:n=>Q(t,m(I)),onKeyup:ge(n=>Q(t,m(I)),["enter"])},null,40,Ge),[[q,t.editing],[ve,m(I)]]),C(o("img",{src:Te,alt:"...",class:"menuButton buttonEffect",onClick:D(n=>ye(n,t),["stop"]),title:"会话设置"},null,8,He),[[q,!t.editing]])],10,ze))),128)),C(o("div",{class:"chatMenu",ref_key:"chatMenu",ref:ne},[o("div",{class:"chatMenuItem buttonEffect",onClick:e[5]||(e[5]=D(t=>Q(m(X),void 0),["stop"])),title:"重命名"},e[16]||(e[16]=[o("img",{src:$e,alt:"",class:"icon"},null,-1),o("span",{class:"text"},"重命名",-1)])),o("div",{class:"chatMenuItem buttonEffect",onClick:e[6]||(e[6]=D(t=>ue(m(X),!0),["stop"])),title:"删除会话"},e[17]||(e[17]=[o("img",{src:te,alt:"",class:"icon"},null,-1),o("span",{class:"text"},"删除会话",-1)]))],512),[[q,P.value]])])],2),C(o("img",{src:xe,alt:"对话",class:"floatChat buttonEffect",onClick:e[7]||(e[7]=t=>_.value=!_.value)},null,512),[[q,m(k).type=="ver"&&c.length>0]]),o("div",Je,[o("div",{class:v(["loading",{show:a.value.status=="unload"}])},e[18]||(e[18]=[o("img",{class:"autoInvert",src:Le,alt:""},null,-1),Be(" 加载中 ")]),2),o("div",{class:v(["startArea",{hasContent:a.value.messages.length>0||a.value.status=="unload"}])},e[19]||(e[19]=[o("div",{class:"title"},[o("img",{src:qe,alt:"MathSolve"}),o("span",null,"你的数学解题助手")],-1),o("div",{class:"subtitle"},"一键求解，轻松解决你的数学烦恼",-1)]),2),o("div",{class:v(["answersArea",{hasContent:a.value.messages.length>0||a.value.status=="unload"}])},[o("div",{class:v(["toolbar",m(k).type])},[m(se)?(f(),h("div",{key:0,onClick:e[8]||(e[8]=t=>he(a.value,"markdown")),class:"buttonEffect"},"导出会话.md")):V("",!0),m(se)?(f(),h("div",{key:1,onClick:e[9]||(e[9]=t=>he(a.value,"json")),class:"buttonEffect"},"导出会话.json")):V("",!0),o("div",{onClick:e[10]||(e[10]=t=>ke()),class:"buttonEffect"},"全部"+B(le.value?"展开":"折叠"),1)],2),o("div",{class:v(["answers",m(k).type]),ref_key:"answers",ref:R},[(f(!0),h(H,null,J(a.value.messages,(t,n)=>(f(),h("div",{class:v(["msg",t.status])},[o("div",Ve,[o("div",{class:v(["foldButton","buttonEffect",{folded:t.fold}]),title:t.fold?"展开":"折叠",onClick:i=>t.fold=!t.fold},[(f(),h("svg",Xe,[o("defs",null,[o("mask",{id:"mask"+n},e[20]||(e[20]=[o("rect",{width:"100%",height:"100%",fill:"white"},null,-1),o("path",{class:"turn",stroke:"black","stroke-linejoin":"round","stroke-miterlimit":"10","stroke-width":"150",d:"m982 926 632 791h-319l-313-391-313 391H350Z"},null,-1)]),8,Ke)]),o("g",Qe,[o("path",{d:"M287 1174h1390v203H287zM287 786h1390v203H287zM287 398h1390v203H287z",style:Ie(`mask:url(#mask${n})`)},null,4),e[21]||(e[21]=o("path",{class:"turn",d:"m982 982 562 702h-284l-278-347-278 347H420Z"},null,-1))])]))],10,Pe),o("div",{class:v(["question",{folded:t.fold,thinking:t.fold&&t.status==="unfinished"}]),title:t.question},B(t.question),11,Ye),t.status=="finished"?(f(),h("img",{key:0,class:"questionBarButton buttonEffect",src:Ne,title:"复制答案为markdown",style:{"margin-right":"15px"},onClick:i=>Ee(t.text)},null,8,We)):V("",!0),o("img",{class:"questionBarButton buttonEffect",src:te,title:"删除",onClick:i=>ce(a.value,t,void 0,!0)},null,8,Ze)]),C(o("br",null,null,512),[[q,!t.fold]]),C(o("div",{class:v({foldable:!0,thinking:t.status==="unfinished"}),style:{display:"flex"}},[t.text.length>0?(f(),Me(s,{key:0,md:t.text,theme:m(x).settings.theme},null,8,["md","theme"])):(f(),h("div",et," ... ")),t.ref_files.length>0?(f(),h("div",tt,[o("div",{class:"filesTitle buttonEffect",onClick:i=>t.ref_show=!t.ref_show},B(t.ref_show?"∧":"∨")+" 参考文档 "+B(t.ref_show?"∧":"∨"),9,st),o("div",{class:v(["filesItems",{show:t.ref_show}])},[(f(!0),h(H,null,J(t.ref_files,i=>(f(),h("a",{class:"filesItem",title:i.name,href:i.url,target:"_blank"},B(i.name),9,nt))),256))],2)])):V("",!0)],2),[[q,!t.fold]])],2))),256)),C(o("div",lt,[e[22]||(e[22]=o("div",{class:"quesTitle"},"继续提问：",-1)),o("div",it,[(f(!0),h(H,null,J(a.value.rel_ques,t=>(f(),h("div",{class:"quesItem buttonEffect",title:t,onClick:n=>Y(t)},B(t),9,ot))),256))])],512),[[q,a.value.rel_ques.length>0]])],2)],2),o("div",{class:v(["requestArea",{hasContent:a.value.messages.length>0||a.value.status=="unload"}])},[o("div",{class:v(["request",m(k).type])},[C(o("textarea",{class:v(["requestbox",m(k).type]),"onUpdate:modelValue":e[11]||(e[11]=t=>a.value.input=t),placeholder:"输入问题，多行输入使用Shift+Enter换行",onKeydown:ge(D(fe,["exact"]),["enter"]),onInput:e[12]||(e[12]=t=>Y()),ref_key:"inputTextarea",ref:L},null,42,rt),[[ve,a.value.input]]),o("div",{class:v(["submitRow",m(k).type])},[o("img",{class:v(["submit",{buttonEffect:!oe.value,disable:oe.value}]),src:Ue,alt:"提问",onClick:fe},null,2)],2)],2)],2)])])}}},ft=be(at,[["__scopeId","data-v-e1c03282"]]);export{ft as default};
