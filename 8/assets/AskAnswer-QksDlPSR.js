import{_ as V,g as w,u as $,r as E,b as D,o as u,c,a as r,w as b,v as F,n as a,d as m,e as I,f as J,F as L,h as R,t as q,i as N,j as z,k as K,l as G,m as U}from"./index-GnwpH1fV.js";const X={class:"question_bar"},H=["title","onClick"],Q=["title"],W=["onClick"],Y={key:0},Z={key:0,style:{width:"fit-content","user-select":"none"},class:"thinking"},ee={key:1},te={__name:"AskAnswer",setup(se){let x=w().proxy.api,d=w().proxy.config,f=w().proxy.screen;const S=$("answers"),l=E([]),_=E(""),O=s=>new Promise(n=>setTimeout(n,s));async function k(s=_.value,n=void 0){if(!d.loginStatus.isLogged){G.emit("startLogin");return}if(s=s.trim(),s.length<=0)return;let t=U({question:s,text:"",status:"unfinished",controller:new AbortController,fold:!1}),e="";n?C(n,t):l.value.push(t);let v=[];v.push({role:"user",content:s}),fetch(x.path+"/v1/chat/completions",{signal:t.controller.signal,method:"POST",headers:{Authorization:"Bearer "+d.loginStatus.userinfo.access_token,"Content-Type":"application/json"},body:JSON.stringify({model:"qwen2.5-math-7b-instruct",messages:v,max_tokens:1e3,temperature:1})}).then(i=>{if(i.status===401)fetch(x.path+"/api/token/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:d.loginStatus.userinfo.refresh_token})}).then(o=>{if(!o.ok)throw Error(o.status+": "+o.statusText);return o.json()}).then(o=>{d.loginStatus.userinfo.access_token=o.access_token,k(s,t)}).catch(o=>{e="[登录过期，请重新登录]",t.status="error",console.error(o)});else if(!i.ok)throw Error(i.status+": "+i.statusText);const B=i.body.getReader(),M=new TextDecoder;let p="";function T(){B.read().then(({done:o,value:P})=>{if(o){t.status="finished";return}p+=M.decode(P,{stream:!0});let y=0,h=0;for(;h=p.indexOf("}",y)+1,h!=0;)try{let A=JSON.parse(p.substring(0,h));if(A.final){t.status="finished";return}e+=A.choices[0].message.content,p=p.substring(h),y=0}catch{y=h}T()}).catch(o=>{if(o.name==="AbortError"){e="",t.status="finished";return}e+="[解析异常]",t.status="error",console.error(o)})}T()}).catch(i=>{if(i.name==="AbortError"){e="",t.status="finished";return}e+="[请求异常]",t.status="error",console.error(i)});let g=0;for(;;){if(g==1&&S.value.scrollTo(0,Number.MAX_SAFE_INTEGER),g<e.length)t.text+=e.at(g),++g;else if(t.status!="unfinished")break;await O(1e3/d.settings.charPerSecond)}}async function C(s,n=void 0){s.controller.abort();let t=l.value.indexOf(s);return n?l.value.splice(t,1,n):l.value.splice(t,1),t}function j(){l.value.forEach(s=>{s.controller.abort()}),l.value.length=0}return(s,n)=>{const t=D("Markdown");return u(),c("div",{class:a(["area",m(f).type])},[r("div",{class:a(["request",m(f).type])},[b(r("textarea",{type:"text",class:a(["requestbox",m(f).type]),"onUpdate:modelValue":n[0]||(n[0]=e=>_.value=e),placeholder:"输入问题",onKeyup:n[1]||(n[1]=I(J(e=>k(),["exact"]),["enter"]))},null,34),[[F,_.value]]),r("div",{class:a(["submit",m(f).type]),onClick:n[2]||(n[2]=e=>k())},"提问",2)],2),r("div",{class:a(["answers",m(f).type]),ref_key:"answers",ref:S},[r("div",null,[r("button",{onClick:j},"清空")]),(u(!0),c(L,null,R(l.value,e=>(u(),c("div",{class:a(["chat",e.status])},[r("div",X,[r("img",{class:"fold",src:"./icon/fold.png",title:e.fold?"展开":"折叠",onClick:v=>e.fold=!e.fold},null,8,H),r("div",{class:a(["question",{fold:e.fold}]),title:e.question},q(e.question),11,Q),r("img",{class:"del",src:"./icon/del.png",title:"删除",onClick:v=>C(e)},null,8,W)]),b(r("br",null,null,512),[[N,!e.fold]]),b(z(t,{class:a({thinking:e.status==="unfinished"}),md:e.text},null,8,["class","md"]),[[N,!e.fold]]),e.status=="unfinished"?(u(),c("div",Y,[e.fold?(u(),c("div",Z,"〇")):(u(),c("div",ee,"......"))])):K("",!0)],2))),256))],2)],2)}}},oe=V(te,[["__scopeId","data-v-19a14445"]]);export{oe as default};
