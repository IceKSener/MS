import{_ as D,g as w,u as I,r as O,b as J,d as L,o as d,c as f,a as r,w as b,v as R,n as l,e as p,f as q,h as z,t as j,F as K,i as G,j as B,k as U,l as X,m as H,p as Q}from"./index-CzAqKdFi.js";const W={class:"toolbar"},Y={class:"question_bar"},Z=["title","onClick"],ee=["title"],te=["onClick"],se={key:0},ne={key:0,style:{width:"fit-content","user-select":"none"},class:"thinking"},oe={key:1},re={__name:"AskAnswer",setup(ae){let x=w().proxy.api,u=w().proxy.config,c=w().proxy.screen;const S=I("answers"),a=O([]),_=O(""),A=J(()=>a.value.every(t=>t.fold)),C=t=>new Promise(n=>setTimeout(n,t));async function k(t=_.value,n=void 0){if(!u.loginStatus.isLogged){H.emit("startLogin");return}if(t=t.trim(),t.length<=0)return;let s=Q({question:t,text:"",status:"unfinished",controller:new AbortController,fold:!1}),e="";n?T(n,s):a.value.push(s);let g=[];g.push({role:"user",content:t}),fetch(x.path+"/v1/chat/completions",{signal:s.controller.signal,method:"POST",headers:{Authorization:"Bearer "+u.loginStatus.userinfo.access_token,"Content-Type":"application/json"},body:JSON.stringify({model:"qwen2.5-math-7b-instruct",messages:g,max_tokens:1e3,temperature:1})}).then(i=>{if(i.status===401)fetch(x.path+"/api/token/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:u.loginStatus.userinfo.refresh_token})}).then(o=>{if(!o.ok)throw Error(o.status+": "+o.statusText);return o.json()}).then(o=>{u.loginStatus.userinfo.access_token=o.access_token,k(t,s)}).catch(o=>{e="[登录过期，请重新登录]",s.status="error",console.error(o)});else if(!i.ok)throw Error(i.status+": "+i.statusText);const P=i.body.getReader(),V=new TextDecoder;let v="";function E(){P.read().then(({done:o,value:$})=>{if(o){s.status="finished";return}v+=V.decode($,{stream:!0});let y=0,m=0;for(;m=v.indexOf("}",y)+1,m!=0;)try{let N=JSON.parse(v.substring(0,m));if(N.final){s.status="finished";return}e+=N.choices[0].message.content,v=v.substring(m),y=0}catch{y=m}E()}).catch(o=>{if(o.name==="AbortError"){e="",s.status="finished";return}e+="[解析异常]",s.status="error",console.error(o)})}E()}).catch(i=>{if(i.name==="AbortError"){e="",s.status="finished";return}e+="[请求异常]",s.status="error",console.error(i)});let h=0;for(;;){if(h==1&&S.value.scrollTo(0,Number.MAX_SAFE_INTEGER),h<e.length)s.text+=e.at(h),++h;else if(s.status!="unfinished"){if(await C(1e3/u.settings.charPerSecond),h<e.length)continue;s.text+="[end]";break}await C(1e3/u.settings.charPerSecond)}}function T(t,n=void 0){t.controller.abort();let s=a.value.indexOf(t);return n?a.value.splice(s,1,n):a.value.splice(s,1),s}function F(){a.value.forEach(t=>{t.controller.abort()}),a.value.length=0}function M(){A.value?a.value.forEach(t=>{t.fold=!1}):a.value.forEach(t=>{t.fold=!0})}return(t,n)=>{const s=L("Markdown");return d(),f("div",{class:l(["area",p(c).type])},[r("div",{class:l(["request",p(c).type])},[b(r("textarea",{type:"text",class:l(["requestbox",p(c).type]),"onUpdate:modelValue":n[0]||(n[0]=e=>_.value=e),placeholder:"输入问题",onKeyup:n[1]||(n[1]=q(z(e=>k(),["exact"]),["enter"]))},null,34),[[R,_.value]]),r("div",{class:l(["submit",p(c).type]),onClick:n[2]||(n[2]=e=>k())},"提问",2)],2),r("div",{class:l(["answersArea",p(c).type])},[r("div",W,[r("button",{onClick:F},"清空"),r("button",{onClick:M},"全部"+j(A.value?"展开":"折叠"),1)]),r("div",{class:l(["answers",p(c).type]),ref_key:"answers",ref:S},[(d(!0),f(K,null,G(a.value,e=>(d(),f("div",{class:l(["chat",e.status])},[r("div",Y,[r("img",{class:"fold",src:"./icon/fold.png",title:e.fold?"展开":"折叠",onClick:g=>e.fold=!e.fold},null,8,Z),r("div",{class:l(["question",{fold:e.fold}]),title:e.question},j(e.question),11,ee),r("img",{class:"del",src:"./icon/del.png",title:"删除",onClick:g=>T(e)},null,8,te)]),b(r("br",null,null,512),[[B,!e.fold]]),b(U(s,{class:l({thinking:e.status==="unfinished"}),md:e.text},null,8,["class","md"]),[[B,!e.fold]]),e.status=="unfinished"?(d(),f("div",se,[e.fold?(d(),f("div",ne,"〇")):(d(),f("div",oe,"......"))])):X("",!0)],2))),256))],2)],2)],2)}}},ie=D(re,[["__scopeId","data-v-0bd19ca2"]]);export{ie as default};
