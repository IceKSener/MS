import{_ as $,g as w,u as z,r as _,d as G,e as U,o as E,c as S,a as t,n as a,f as u,t as D,F as X,h as Q,w as A,v as L,i as W,j as Y,k as Z,l as ee,m as C,p as te}from"./index-9i1YZbGm.js";const se={class:"question_bar"},ne=["title","onClick"],le=["title"],oe=["onClick"],re=["onKeydown"],ae={__name:"AskAnswer",setup(ie){let T=w().proxy.api,d=w().proxy.config,c=w().proxy.screen;const I=z("answers"),l=_([]),m=_(""),h=_(),N=G(()=>l.value.every(s=>s.fold));window.chats=l.value;function R(s){h.value.style.height="auto",h.value.style.height=h.value.scrollHeight+"px"}function q(s){s.preventDefault(),y()}async function y(s=m.value,o=void 0){if(!d.loginStatus.isLogged){C.emit("startLogin",{msg:"请登录后使用",err:!0});return}if(s=s.trim(),s.length<=0)return;let n=te({question:s,text:"",status:"unfinished",controller:new AbortController,fold:!1}),e="";o?O(o,n):l.value.push(n);let g=[];g.push({role:"user",content:s}),fetch(T.path+"/v1/chat/completions",{signal:n.controller.signal,method:"POST",headers:{Authorization:"Bearer "+d.loginStatus.userinfo.access_token,"Content-Type":"application/json"},body:JSON.stringify({model:"qwen2.5-math-7b-instruct",messages:g,max_tokens:1e3,temperature:1})}).then(i=>{if(i.status===401)fetch(T.path+"/api/token/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:d.loginStatus.userinfo.refresh_token})}).then(r=>{if(!r.ok)throw Error(r.status+": "+r.statusText);return r.json()}).then(r=>{d.loginStatus.userinfo.access_token=r.access_token,y(s,n)}).catch(r=>{e="[登录过期，请重新登录]",n.status="error",C.emit("logout"),C.emit("startLogin",{msg:"登录过期，请重新登录",err:!0}),console.error(r)});else if(!i.ok)throw Error(i.status+": "+i.statusText);const K=i.body.getReader(),P=new TextDecoder;let v="";function M(){K.read().then(({done:r,value:V})=>{if(r){n.status="finished";return}v+=P.decode(V,{stream:!0});let k=0,p=0;for(;p=v.indexOf("}",k)+1,p!=0;)try{let B=JSON.parse(v.substring(0,p));if(B.final){n.status="finished";return}e+=B.choices[0].message.content,v=v.substring(p),k=0}catch{k=p}M()}).catch(r=>{if(r.name==="AbortError"){e="",n.status="finished";return}e+="[解析异常]",n.status="error",console.error(r)})}M()}).catch(i=>{if(i.name==="AbortError"){e="",n.status="finished";return}e+="[请求异常]",n.status="error",console.error(i)});let f=0,j=0,F=0,x="",b=0;j=setInterval(()=>{if(f==1&&I.value.scrollTo(0,Number.MAX_SAFE_INTEGER),f<e.length)x+=e.at(f),++f;else if(n.status!="unfinished"){if(f<e.length){b=0;return}else if(b<5){b++;return}clearInterval(j),n.text=x,clearInterval(F)}},1e3/d.settings.charPerSecond),F=setInterval(()=>{n.text=x},1e3/20)}function O(s,o=void 0){s.controller.abort();let n=l.value.indexOf(s);return o?l.value.splice(n,1,o):l.value.splice(n,1),n}function H(){l.value.forEach(s=>{s.controller.abort()}),l.value.length=0}function J(){N.value?l.value.forEach(s=>{s.fold=!1}):l.value.forEach(s=>{s.fold=!0})}return(s,o)=>{const n=U("Markdown");return E(),S("div",{class:a(["area",u(c).type])},[t("div",{class:a(["startArea",{hasContent:l.value.length>0}])},o[2]||(o[2]=[t("div",{class:"title"},[t("img",{src:"./logo.png",alt:"MathSolve"}),t("span",null,"你的数学解题助手")],-1),t("div",{class:"subtitle"},"一键求解，轻松解决你的数学烦恼",-1)]),2),t("div",{class:a(["answersArea",{hasContent:l.value.length>0}])},[t("div",{class:a(["toolbar",u(c).type])},[t("div",{onClick:H,class:"buttonEffect"},"清空"),t("div",{onClick:J,class:"buttonEffect"},"全部"+D(N.value?"展开":"折叠"),1)],2),t("div",{class:a(["answers",u(c).type]),ref_key:"answers",ref:I},[(E(!0),S(X,null,Q(l.value,e=>(E(),S("div",{class:a(["chat",e.status])},[t("div",se,[t("img",{class:"fold buttonEffect",src:"./icon/fold.png",title:e.fold?"展开":"折叠",onClick:g=>e.fold=!e.fold},null,8,ne),t("div",{class:a(["question",{fold:e.fold,thinking:e.fold&&e.status==="unfinished"}]),title:e.question},D(e.question),11,le),t("img",{class:"del buttonEffect",src:"./icon/del.png",title:"删除",onClick:g=>O(e)},null,8,oe)]),A(t("br",null,null,512),[[L,!e.fold]]),A(t("div",{class:a({thinking:e.status==="unfinished"}),style:{display:"flex"}},[W(n,{md:e.text,theme:u(d).settings.theme,style:{width:"0",flex:"1","overflow-x":"auto"}},null,8,["md","theme"])],2),[[L,!e.fold]])],2))),256))],2)],2),t("div",{class:a(["requestArea",{hasContent:l.value.length>0}])},[t("div",{class:a(["request",u(c).type])},[A(t("textarea",{contenteditable:"true",class:a(["requestbox",u(c).type]),"onUpdate:modelValue":o[0]||(o[0]=e=>m.value=e),placeholder:"输入问题，多行输入使用Shift+Enter换行",onKeydown:Z(ee(q,["exact"]),["enter"]),onInput:R,ref_key:"inputTextarea",ref:h},null,42,re),[[Y,m.value]]),t("div",{class:a(["submitRow",u(c).type])},[t("div",{class:a(["submit",u(c).type,"buttonEffect"]),onClick:o[1]||(o[1]=e=>y())},o[3]||(o[3]=[t("img",{src:"./icon/submit.png",alt:"提问"},null,-1)]),2)],2)],2)],2)],2)}}},ce=$(ae,[["__scopeId","data-v-495e431c"]]);export{ce as default};
