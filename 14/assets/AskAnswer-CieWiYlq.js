import{_ as Q,g as O,r as b,d as M,e as ee,w as te,f as se,o as f,c as v,a as t,u as o,t as C,F as K,h as P,n as a,i as ne,j as X,k as E,v as j,l as le,m as oe,p as ie,q as ae,s as A}from"./index-Ds1V1RhB.js";const re={class:"area"},ue={class:"functions"},ce=["title"],de={class:"chats"},fe=["onClick"],ve=["title"],he=["title"],ge=["onClick"],pe={class:"mainArea"},me={class:"question_bar"},ke=["title","onClick"],we={xmlns:"http://www.w3.org/2000/svg","xml:space":"preserve",viewBox:"0 0 1964 1963",overflow:"hidden"},xe=["id"],ye={fill:"#393C45"},_e=["title"],be=["onClick"],Ce={key:1},Ee=["onKeydown"],Ae={__name:"AskAnswer",setup(Se){let H=O().proxy.api,p=O().proxy.config,h=O().proxy.screen,l=b();const u=M([]),c=b(!1),x=b(),T=b(),z=ee(()=>l.value.messages.every(n=>n.fold));te(u,()=>{c.value=u.length<=0?!1:c.value}),window.chats=u;function S(n=!1){u.indexOf(l.value)<0&&!n||(l.value=M({title:"",messages:[],session_id:null,input:""}))}S(!0);function V(n){A.emit("dialog",{text:"确定删除该会话吗？",onYes(){let s=u.indexOf(n);u[s]==l.value&&S(),L(n),u.splice(s,1)}})}function Z(){x.value.style.height="auto",x.value.style.height=x.value.scrollHeight+"px"}function F(n){n.preventDefault(),N(l.value.input),l.value.input=""}async function N(n,s=void 0,d=l.value){if(!p.loginStatus.isLogged){A.emit("startLogin",{msg:"请登录后使用",err:!0});return}if(n=n.trim(),n.length<=0)return;let e=M({question:n,text:"",status:"unfinished",controller:new AbortController,fold:!1}),i="";s?D(d,s,e):d.messages.push(e),u.indexOf(d)<0&&(d.title=n,u.push(d));let y=[];y.push({role:"user",content:n}),fetch(H.path+"/v1/chat/completions",{signal:e.controller.signal,method:"POST",headers:{Authorization:"Bearer "+p.loginStatus.userinfo.access_token,"Content-Type":"application/json"},body:JSON.stringify({model:"qwen2.5-math-7b-instruct",messages:y,max_tokens:1e3,temperature:1})}).then(g=>{if(g.status===401)fetch(H.path+"/api/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:p.loginStatus.userinfo.refresh_token})}).then(r=>r.json()).then(r=>{if(r.code!=200)throw Error(r.code+": "+r.message);p.loginStatus.userinfo.access_token=r.data.access_token,N(n,e)}).catch(r=>{i="[登录过期，请重新登录]",e.status="error",A.emit("logout"),A.emit("startLogin",{msg:"登录过期，请重新登录",err:!0}),console.error(r)});else if(!g.ok)throw Error(g.status+": "+g.statusText);const U=g.body.getReader(),W=new TextDecoder;let k="";function q(){U.read().then(({done:r,value:Y})=>{if(r){e.status="finished";return}k+=W.decode(Y,{stream:!0});let $=0,w=0;for(;w=k.indexOf("}",$)+1,w!=0;)try{let J=JSON.parse(k.substring(0,w));if(J.final){e.status="finished";return}i+=J.choices[0].message.content,k=k.substring(w),$=0}catch{$=w}q()}).catch(r=>{if(r.name==="AbortError"){i="",e.status="finished";return}i+="[解析异常]",e.status="error",console.error(r)})}q()}).catch(g=>{if(g.name==="AbortError"){i="",e.status="finished";return}i+="[请求异常]",e.status="error",console.error(g)});let m=0,R=0,_=0,B="",I=0;p.settings.printByWord?(R=setInterval(()=>{if(m==1&&T.value.scrollTo(0,Number.MAX_SAFE_INTEGER),m<i.length)B+=i.at(m),++m;else if(e.status!="unfinished"){if(m<i.length){I=0;return}else if(I<5){I++;return}clearInterval(R),e.text=B,clearInterval(_)}},1e3/p.settings.charPerSecond),_=setInterval(()=>{e.text=B},1e3/20)):_=setInterval(()=>{e.text=i,e.status!="unfinished"&&(e.text=i,clearInterval(_))},1e3/20)}function D(n,s,d=void 0){s.controller.abort();let e=n.messages.indexOf(s);return d?n.messages.splice(e,1,d):n.messages.splice(e,1),e}function L(n=l.value){console.log(n),n.messages.forEach(s=>{s.controller.abort()}),n.messages.length=0}function G(){z.value?l.value.messages.forEach(n=>{n.fold=!1}):l.value.messages.forEach(n=>{n.fold=!0})}return(n,s)=>{const d=se("Markdown");return f(),v("div",re,[t("div",{class:a(["chatsBar",o(h).type,{show:u.length>0,active:c.value}])},[t("div",ue,[o(h).type=="hor"?(f(),v("div",{key:0,class:"toggleBar buttonEffect",onClick:s[0]||(s[0]=e=>c.value=!c.value),title:c.value?"收回":"展开"},C(c.value?"<":">"),9,ce)):(f(),v("div",{key:1,class:"toggleBar buttonEffect",onClick:s[1]||(s[1]=e=>c.value=!1),title:"关闭"},s[7]||(s[7]=[t("img",{src:"./icon/del.svg",alt:" X"},null,-1)]))),t("div",{class:"addButton buttonEffect",onClick:s[2]||(s[2]=e=>S()),title:"创建新会话"},s[8]||(s[8]=[t("img",{src:"./icon/add.svg",alt:"add"},null,-1),t("div",null,"创建新会话",-1)]))]),t("div",de,[(f(!0),v(K,null,P(u,e=>(f(),v("div",{class:a(["buttonEffect","chatItem",{active:o(l)==e}]),onClick:i=>ne(l)?l.value=e:l=e},[t("img",{src:"./icon/chat.svg",alt:"C",class:"chatIcon",title:e.title},null,8,ve),t("span",{title:e.title},C(e.title),9,he),t("img",{src:"./icon/del.svg",alt:"X",class:"delButton buttonEffect",onClick:X(i=>V(e),["stop"])},null,8,ge)],10,fe))),256))])],2),E(t("img",{src:"./icon/chat.svg",alt:"对话",class:"floatChat buttonEffect",onClick:s[3]||(s[3]=e=>c.value=!c.value)},null,512),[[j,o(h).type=="ver"&&u.length>0]]),t("div",pe,[t("div",{class:a(["startArea",{hasContent:o(l).messages.length>0}])},s[9]||(s[9]=[t("div",{class:"title"},[t("img",{src:"./logo.png",alt:"MathSolve"}),t("span",null,"你的数学解题助手")],-1),t("div",{class:"subtitle"},"一键求解，轻松解决你的数学烦恼",-1)]),2),t("div",{class:a(["answersArea",{hasContent:o(l).messages.length>0}])},[t("div",{class:a(["toolbar",o(h).type])},[t("div",{onClick:s[4]||(s[4]=e=>L()),class:"buttonEffect"},"清空"),t("div",{onClick:s[5]||(s[5]=e=>G()),class:"buttonEffect"},"全部"+C(z.value?"展开":"折叠"),1)],2),t("div",{class:a(["answers",o(h).type]),ref_key:"answers",ref:T},[(f(!0),v(K,null,P(o(l).messages,(e,i)=>(f(),v("div",{class:a(["msg",e.status])},[t("div",me,[t("div",{class:a(["foldButton","buttonEffect",{folded:e.fold}]),title:e.fold?"展开":"折叠",onClick:y=>e.fold=!e.fold},[(f(),v("svg",we,[t("defs",null,[t("mask",{id:"mask"+i},s[10]||(s[10]=[t("rect",{width:"100%",height:"100%",fill:"white"},null,-1),t("path",{class:"turn",stroke:"black","stroke-linejoin":"round","stroke-miterlimit":"10","stroke-width":"150",d:"m982 926 632 791h-319l-313-391-313 391H350Z"},null,-1)]),8,xe)]),t("g",ye,[t("path",{d:"M287 1174h1390v203H287zM287 786h1390v203H287zM287 398h1390v203H287z",style:le(`mask:url(#mask${i})`)},null,4),s[11]||(s[11]=t("path",{class:"turn",d:"m982 982 562 702h-284l-278-347-278 347H420Z"},null,-1))])]))],10,ke),t("div",{class:a(["question",{folded:e.fold,thinking:e.fold&&e.status==="unfinished"}]),title:e.question},C(e.question),11,_e),t("img",{class:"delButton buttonEffect",src:"./icon/del.svg",title:"删除",onClick:y=>D(o(l),e)},null,8,be)]),E(t("br",null,null,512),[[j,!e.fold]]),E(t("div",{class:a({thinking:e.status==="unfinished"}),style:{display:"flex"}},[e.text.length>0?(f(),oe(d,{key:0,md:e.text,theme:o(p).settings.theme,style:{width:"0",flex:"1","overflow-x":"auto"}},null,8,["md","theme"])):(f(),v("div",Ce," ... "))],2),[[j,!e.fold]])],2))),256))],2)],2),t("div",{class:a(["requestArea",{hasContent:o(l).messages.length>0}])},[t("div",{class:a(["request",o(h).type])},[E(t("textarea",{contenteditable:"true",class:a(["requestbox",o(h).type]),"onUpdate:modelValue":s[6]||(s[6]=e=>o(l).input=e),placeholder:"输入问题，多行输入使用Shift+Enter换行",onKeydown:ae(X(F,["exact"]),["enter"]),onInput:Z,ref_key:"inputTextarea",ref:x},null,42,Ee),[[ie,o(l).input]]),t("div",{class:a(["submitRow",o(h).type])},[t("img",{class:"submit buttonEffect",src:"./icon/submit.svg",alt:"提问",onClick:F})],2)],2)],2)])])}}},Ie=Q(Ae,[["__scopeId","data-v-bc7faeca"]]);export{Ie as default};
