import{_ as te,g as M,r as b,e as R,f as se,w as ne,h as le,o as f,c as v,a as t,u as i,t as C,F as K,i as P,n as a,j as oe,k as G,l as E,v as T,b as ie,m as ae,p as re,q as ue,s as ce,x as A}from"./index-WQHIRrcV.js";const L=""+new URL("../icon/del.svg",import.meta.url).href,de=""+new URL("../icon/add.svg",import.meta.url).href,V=""+new URL("../icon/chat.svg",import.meta.url).href,fe=""+new URL("../icon/submit.svg",import.meta.url).href,ve={class:"area"},he={class:"functions"},me=["title"],pe={class:"chats"},ge=["onClick"],_e=["title"],ke=["title"],we=["onClick"],xe={class:"mainArea"},ye={class:"question_bar"},be=["title","onClick"],Ce={xmlns:"http://www.w3.org/2000/svg","xml:space":"preserve",viewBox:"0 0 1964 1963",overflow:"hidden"},Ee=["id"],Ae={fill:"#393C45"},Se=["title"],Be=["onClick"],Ie={key:1},$e=["onKeydown"],Oe={__name:"AskAnswer",setup(Me){let N=M().proxy.api,p=M().proxy.config,h=M().proxy.screen,l=b();const u=R([]),c=b(!1),_=b(),S=b(),j=se(()=>l.value.messages.every(n=>n.fold));ne(u,()=>{c.value=u.length<=0?!1:c.value}),window.chats=u;function B(n=!1){u.indexOf(l.value)<0&&!n||(l.value=R({title:"",messages:[],session_id:null,input:""}))}B(!0);function Z(n){A.emit("dialog",{text:"确定删除该会话吗？",onYes(){let s=u.indexOf(n);u[s]==l.value&&B(),D(n),u.splice(s,1)}})}function F(){_.value.style.height="auto",_.value.style.height=_.value.scrollHeight+"px"}function H(n){n.preventDefault(),z(l.value.input),l.value.input="",_.value.value="",F()}async function z(n,s=void 0,d=l.value){if(!p.loginStatus.isLogged){A.emit("startLogin",{msg:"请登录后使用",err:!0});return}if(n=n.trim(),n.length<=0)return;let e=R({question:n,text:"",status:"unfinished",controller:new AbortController,fold:!1}),o="";s?U(d,s,e):d.messages.push(e),u.indexOf(d)<0&&(d.title=n,u.push(d));let x=[];x.push({role:"user",content:n}),fetch(N.path+"/v1/chat/completions",{signal:e.controller.signal,method:"POST",headers:{Authorization:"Bearer "+p.loginStatus.userinfo.access_token,"Content-Type":"application/json"},body:JSON.stringify({model:"qwen2.5-math-7b-instruct",messages:x,max_tokens:1e3,temperature:1})}).then(m=>{if(m.status===401)fetch(N.path+"/api/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:p.loginStatus.userinfo.refresh_token})}).then(r=>r.json()).then(r=>{if(r.code!=200)throw Error(r.code+": "+r.message);p.loginStatus.userinfo.access_token=r.data.access_token,z(n,e)}).catch(r=>{o="[登录过期，请重新登录]",e.status="error",A.emit("logout"),A.emit("startLogin",{msg:"登录过期，请重新登录",err:!0}),console.error(r)});else if(!m.ok)throw Error(m.status+": "+m.statusText);const Y=m.body.getReader(),Q=new TextDecoder;let k="";function q(){Y.read().then(({done:r,value:ee})=>{if(r){e.status="finished";return}k+=Q.decode(ee,{stream:!0});let O=0,w=0;for(;w=k.indexOf("}",O)+1,w!=0;)try{let J=JSON.parse(k.substring(0,w));if(J.final){e.status="finished";return}o+=J.choices[0].message.content,k=k.substring(w),O=0}catch{O=w}q()}).catch(r=>{if(r.name==="AbortError"){o="",e.status="finished";return}o+="[解析异常]",e.status="error",console.error(r)})}q()}).catch(m=>{if(m.name==="AbortError"){o="",e.status="finished";return}o+="[请求异常]",e.status="error",console.error(m)});let g=0,X=0,y=0,I="",$=0;p.settings.printByWord?(X=setInterval(()=>{if(g==1&&S.value.scrollTo(0,Number.MAX_SAFE_INTEGER),g<o.length)I+=o.at(g),++g;else if(e.status!="unfinished"){if(g<o.length){$=0;return}else if($<5){$++;return}clearInterval(X),e.text=I,clearInterval(y)}},1e3/p.settings.charPerSecond),y=setInterval(()=>{e.text=I},1e3/20)):y=setInterval(()=>{e.text=o,g==1&&o.length>0&&S.value.scrollTo(0,Number.MAX_SAFE_INTEGER),g++,e.status!="unfinished"&&(e.text=o,clearInterval(y))},1e3/20)}function U(n,s,d=void 0){s.controller.abort();let e=n.messages.indexOf(s);return d?n.messages.splice(e,1,d):n.messages.splice(e,1),e}function D(n=l.value){console.log(n),n.messages.forEach(s=>{s.controller.abort()}),n.messages.length=0}function W(){j.value?l.value.messages.forEach(n=>{n.fold=!1}):l.value.messages.forEach(n=>{n.fold=!0})}return(n,s)=>{const d=le("Markdown");return f(),v("div",ve,[t("div",{class:a(["chatsBar",i(h).type,{show:u.length>0,active:c.value}])},[t("div",he,[i(h).type=="hor"?(f(),v("div",{key:0,class:"toggleBar buttonEffect",onClick:s[0]||(s[0]=e=>c.value=!c.value),title:c.value?"收回":"展开"},C(c.value?"<":">"),9,me)):(f(),v("div",{key:1,class:"toggleBar buttonEffect",onClick:s[1]||(s[1]=e=>c.value=!1),title:"关闭"},s[7]||(s[7]=[t("img",{src:L,alt:" X"},null,-1)]))),t("div",{class:"addButton buttonEffect",onClick:s[2]||(s[2]=e=>B()),title:"创建新会话"},s[8]||(s[8]=[t("img",{src:de,alt:"add"},null,-1),t("div",null,"创建新会话",-1)]))]),t("div",pe,[(f(!0),v(K,null,P(u,e=>(f(),v("div",{class:a(["buttonEffect","chatItem",{active:i(l)==e}]),onClick:o=>oe(l)?l.value=e:l=e},[t("img",{src:V,alt:"C",class:"chatIcon",title:e.title},null,8,_e),t("span",{title:e.title},C(e.title),9,ke),t("img",{src:L,alt:"X",class:"delButton buttonEffect",onClick:G(o=>Z(e),["stop"])},null,8,we)],10,ge))),256))])],2),E(t("img",{src:V,alt:"对话",class:"floatChat buttonEffect",onClick:s[3]||(s[3]=e=>c.value=!c.value)},null,512),[[T,i(h).type=="ver"&&u.length>0]]),t("div",xe,[t("div",{class:a(["startArea",{hasContent:i(l).messages.length>0}])},s[9]||(s[9]=[t("div",{class:"title"},[t("img",{src:ie,alt:"MathSolve"}),t("span",null,"你的数学解题助手")],-1),t("div",{class:"subtitle"},"一键求解，轻松解决你的数学烦恼",-1)]),2),t("div",{class:a(["answersArea",{hasContent:i(l).messages.length>0}])},[t("div",{class:a(["toolbar",i(h).type])},[t("div",{onClick:s[4]||(s[4]=e=>D()),class:"buttonEffect"},"清空"),t("div",{onClick:s[5]||(s[5]=e=>W()),class:"buttonEffect"},"全部"+C(j.value?"展开":"折叠"),1)],2),t("div",{class:a(["answers",i(h).type]),ref_key:"answers",ref:S},[(f(!0),v(K,null,P(i(l).messages,(e,o)=>(f(),v("div",{class:a(["msg",e.status])},[t("div",ye,[t("div",{class:a(["foldButton","buttonEffect",{folded:e.fold}]),title:e.fold?"展开":"折叠",onClick:x=>e.fold=!e.fold},[(f(),v("svg",Ce,[t("defs",null,[t("mask",{id:"mask"+o},s[10]||(s[10]=[t("rect",{width:"100%",height:"100%",fill:"white"},null,-1),t("path",{class:"turn",stroke:"black","stroke-linejoin":"round","stroke-miterlimit":"10","stroke-width":"150",d:"m982 926 632 791h-319l-313-391-313 391H350Z"},null,-1)]),8,Ee)]),t("g",Ae,[t("path",{d:"M287 1174h1390v203H287zM287 786h1390v203H287zM287 398h1390v203H287z",style:ae(`mask:url(#mask${o})`)},null,4),s[11]||(s[11]=t("path",{class:"turn",d:"m982 982 562 702h-284l-278-347-278 347H420Z"},null,-1))])]))],10,be),t("div",{class:a(["question",{folded:e.fold,thinking:e.fold&&e.status==="unfinished"}]),title:e.question},C(e.question),11,Se),t("img",{class:"delButton buttonEffect",src:L,title:"删除",onClick:x=>U(i(l),e)},null,8,Be)]),E(t("br",null,null,512),[[T,!e.fold]]),E(t("div",{class:a({thinking:e.status==="unfinished"}),style:{display:"flex"}},[e.text.length>0?(f(),re(d,{key:0,md:e.text,theme:i(p).settings.theme,style:{width:"0",flex:"1","overflow-x":"auto"}},null,8,["md","theme"])):(f(),v("div",Ie," ... "))],2),[[T,!e.fold]])],2))),256))],2)],2),t("div",{class:a(["requestArea",{hasContent:i(l).messages.length>0}])},[t("div",{class:a(["request",i(h).type])},[E(t("textarea",{contenteditable:"true",class:a(["requestbox",i(h).type]),"onUpdate:modelValue":s[6]||(s[6]=e=>i(l).input=e),placeholder:"输入问题，多行输入使用Shift+Enter换行",onKeydown:ce(G(H,["exact"]),["enter"]),onInput:F,ref_key:"inputTextarea",ref:_},null,42,$e),[[ue,i(l).input]]),t("div",{class:a(["submitRow",i(h).type])},[t("img",{class:"submit buttonEffect",src:fe,alt:"提问",onClick:H})],2)],2)],2)])])}}},Te=te(Oe,[["__scopeId","data-v-859e2556"]]);export{Te as default};
