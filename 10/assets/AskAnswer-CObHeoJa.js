import{_ as P,g as b,u as R,r as B,d as z,e as K,o as c,c as d,a as n,w as S,v as G,n as a,f,h as U,i as X,t as M,F as H,j as Q,k as L,l as W,m as Y,p as A,q as Z}from"./index-Ava0Aiw2.js";const ee={class:"toolbar"},te={class:"question_bar"},se=["title","onClick"],ne=["title"],oe=["onClick"],re={key:0},le={key:0,style:{width:"fit-content","user-select":"none"},class:"thinking"},ae={key:1},ie={__name:"AskAnswer",setup(ue){let C=b().proxy.api,p=b().proxy.config,u=b().proxy.screen;const E=R("answers"),l=B([]),_=B(""),T=z(()=>l.value.every(s=>s.fold));window.chats=l.value;async function y(s=_.value,r=void 0){if(!p.loginStatus.isLogged){A.emit("startLogin",{msg:"请登录后使用",err:!0});return}if(s=s.trim(),s.length<=0)return;let t=Z({question:s,text:"",status:"unfinished",controller:new AbortController,fold:!1}),e="";r?I(r,t):l.value.push(t);let g=[];g.push({role:"user",content:s}),fetch(C.path+"/v1/chat/completions",{signal:t.controller.signal,method:"POST",headers:{Authorization:"Bearer "+p.loginStatus.userinfo.access_token,"Content-Type":"application/json"},body:JSON.stringify({model:"qwen2.5-math-7b-instruct",messages:g,max_tokens:1e3,temperature:1})}).then(i=>{if(i.status===401)fetch(C.path+"/api/token/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:p.loginStatus.userinfo.refresh_token})}).then(o=>{if(!o.ok)throw Error(o.status+": "+o.statusText);return o.json()}).then(o=>{p.loginStatus.userinfo.access_token=o.access_token,y(s,t)}).catch(o=>{e="[登录过期，请重新登录]",t.status="error",A.emit("logout"),A.emit("startLogin",{msg:"登录过期，请重新登录",err:!0}),console.error(o)});else if(!i.ok)throw Error(i.status+": "+i.statusText);const q=i.body.getReader(),D=new TextDecoder;let h="";function j(){q.read().then(({done:o,value:J})=>{if(o){t.status="finished";return}h+=D.decode(J,{stream:!0});let w=0,m=0;for(;m=h.indexOf("}",w)+1,m!=0;)try{let F=JSON.parse(h.substring(0,m));if(F.final){t.status="finished";return}e+=F.choices[0].message.content,h=h.substring(m),w=0}catch{w=m}j()}).catch(o=>{if(o.name==="AbortError"){e="",t.status="finished";return}e+="[解析异常]",t.status="error",console.error(o)})}j()}).catch(i=>{if(i.name==="AbortError"){e="",t.status="finished";return}e+="[请求异常]",t.status="error",console.error(i)});let v=0,N=0,O=0,k="",x=0;N=setInterval(()=>{if(v==1&&E.value.scrollTo(0,Number.MAX_SAFE_INTEGER),v<e.length)k+=e.at(v),++v;else if(t.status!="unfinished"){if(v<e.length){x=0;return}else if(x<5){x++;return}clearInterval(N),t.text=k,clearInterval(O)}},1e3/p.settings.charPerSecond),O=setInterval(()=>{t.text=k},1e3/20)}function I(s,r=void 0){s.controller.abort();let t=l.value.indexOf(s);return r?l.value.splice(t,1,r):l.value.splice(t,1),t}function V(){l.value.forEach(s=>{s.controller.abort()}),l.value.length=0}function $(){T.value?l.value.forEach(s=>{s.fold=!1}):l.value.forEach(s=>{s.fold=!0})}return(s,r)=>{const t=K("Markdown");return c(),d("div",{class:a(["area",f(u).type])},[n("div",{class:a(["request",f(u).type])},[S(n("textarea",{type:"text",class:a(["requestbox",f(u).type]),"onUpdate:modelValue":r[0]||(r[0]=e=>_.value=e),placeholder:"输入问题",onKeyup:r[1]||(r[1]=U(X(e=>y(),["exact"]),["enter"]))},null,34),[[G,_.value]]),n("div",{class:a(["submit",f(u).type]),onClick:r[2]||(r[2]=e=>y())},"提问",2)],2),n("div",{class:a(["answersArea",f(u).type])},[n("div",ee,[n("button",{onClick:V},"清空"),n("button",{onClick:$},"全部"+M(T.value?"展开":"折叠"),1)]),n("div",{class:a(["answers",f(u).type]),ref_key:"answers",ref:E},[(c(!0),d(H,null,Q(l.value,e=>(c(),d("div",{class:a(["chat",e.status])},[n("div",te,[n("img",{class:"fold",src:"./icon/fold.png",title:e.fold?"展开":"折叠",onClick:g=>e.fold=!e.fold},null,8,se),n("div",{class:a(["question",{fold:e.fold}]),title:e.question},M(e.question),11,ne),n("img",{class:"del",src:"./icon/del.png",title:"删除",onClick:g=>I(e)},null,8,oe)]),S(n("br",null,null,512),[[L,!e.fold]]),n("div",{class:a({thinking:e.status==="unfinished"}),style:{display:"flex"}},[S(W(t,{md:e.text,style:{width:"0",flex:"1","overflow-x":"auto"}},null,8,["md"]),[[L,!e.fold]])],2),e.status=="unfinished"?(c(),d("div",re,[e.fold?(c(),d("div",le,"〇")):(c(),d("div",ae,"......"))])):Y("",!0)],2))),256))],2)],2)],2)}}},de=P(ie,[["__scopeId","data-v-36e60da9"]]);export{de as default};
