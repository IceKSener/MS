import{_ as V,g as w,u as $,r as E,d as G,e as U,o as g,c as _,a as t,n as r,f as u,t as L,F as X,h as Q,w as S,v as R,i as W,j as Y,k as Z,l as ee,m as A,p as te}from"./index-BHJLfP0B.js";const se={class:"question_bar"},ne=["title","onClick"],le=["title"],oe=["onClick"],re={key:1},ae=["onKeydown"],ie={__name:"AskAnswer",setup(ue){let C=w().proxy.api,d=w().proxy.config,c=w().proxy.screen;const T=$("answers"),l=E([]),f=E(""),m=E(),I=G(()=>l.value.every(s=>s.fold));window.chats=l.value;function q(s){m.value.style.height="auto",m.value.style.height=m.value.scrollHeight+"px"}function O(s){s.preventDefault(),j(f.value),f.value=""}async function j(s=f.value,a=void 0){if(!d.loginStatus.isLogged){A.emit("startLogin",{msg:"请登录后使用",err:!0});return}if(s=s.trim(),s.length<=0)return;let n=te({question:s,text:"",status:"unfinished",controller:new AbortController,fold:!1}),e="";a?B(a,n):l.value.push(n);let y=[];y.push({role:"user",content:s}),fetch(C.path+"/v1/chat/completions",{signal:n.controller.signal,method:"POST",headers:{Authorization:"Bearer "+d.loginStatus.userinfo.access_token,"Content-Type":"application/json"},body:JSON.stringify({model:"qwen2.5-math-7b-instruct",messages:y,max_tokens:1e3,temperature:1})}).then(i=>{if(i.status===401)fetch(C.path+"/api/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:d.loginStatus.userinfo.refresh_token})}).then(o=>o.json()).then(o=>{if(o.code!=200)throw Error(o.code+": "+o.message);d.loginStatus.userinfo.access_token=o.data.access_token,j(s,n)}).catch(o=>{e="[登录过期，请重新登录]",n.status="error",A.emit("logout"),A.emit("startLogin",{msg:"登录过期，请重新登录",err:!0}),console.error(o)});else if(!i.ok)throw Error(i.status+": "+i.statusText);const P=i.body.getReader(),z=new TextDecoder;let h="";function N(){P.read().then(({done:o,value:H})=>{if(o){n.status="finished";return}h+=z.decode(H,{stream:!0});let x=0,p=0;for(;p=h.indexOf("}",x)+1,p!=0;)try{let D=JSON.parse(h.substring(0,p));if(D.final){n.status="finished";return}e+=D.choices[0].message.content,h=h.substring(p),x=0}catch{x=p}N()}).catch(o=>{if(o.name==="AbortError"){e="",n.status="finished";return}e+="[解析异常]",n.status="error",console.error(o)})}N()}).catch(i=>{if(i.name==="AbortError"){e="",n.status="finished";return}e+="[请求异常]",n.status="error",console.error(i)});let v=0,F=0,M=0,b="",k=0;F=setInterval(()=>{if(v==1&&T.value.scrollTo(0,Number.MAX_SAFE_INTEGER),v<e.length)b+=e.at(v),++v;else if(n.status!="unfinished"){if(v<e.length){k=0;return}else if(k<5){k++;return}clearInterval(F),n.text=b,clearInterval(M)}},1e3/d.settings.charPerSecond),M=setInterval(()=>{n.text=b},1e3/20)}function B(s,a=void 0){s.controller.abort();let n=l.value.indexOf(s);return a?l.value.splice(n,1,a):l.value.splice(n,1),n}function J(){l.value.forEach(s=>{s.controller.abort()}),l.value.length=0}function K(){I.value?l.value.forEach(s=>{s.fold=!1}):l.value.forEach(s=>{s.fold=!0})}return(s,a)=>{const n=U("Markdown");return g(),_("div",{class:r(["area",u(c).type])},[t("div",{class:r(["startArea",{hasContent:l.value.length>0}])},a[1]||(a[1]=[t("div",{class:"title"},[t("img",{src:"./logo.png",alt:"MathSolve"}),t("span",null,"你的数学解题助手")],-1),t("div",{class:"subtitle"},"一键求解，轻松解决你的数学烦恼",-1)]),2),t("div",{class:r(["answersArea",{hasContent:l.value.length>0}])},[t("div",{class:r(["toolbar",u(c).type])},[t("div",{onClick:J,class:"buttonEffect"},"清空"),t("div",{onClick:K,class:"buttonEffect"},"全部"+L(I.value?"展开":"折叠"),1)],2),t("div",{class:r(["answers",u(c).type]),ref_key:"answers",ref:T},[(g(!0),_(X,null,Q(l.value,e=>(g(),_("div",{class:r(["chat",e.status])},[t("div",se,[t("img",{class:"fold buttonEffect",src:"./icon/fold.png",title:e.fold?"展开":"折叠",onClick:y=>e.fold=!e.fold},null,8,ne),t("div",{class:r(["question",{fold:e.fold,thinking:e.fold&&e.status==="unfinished"}]),title:e.question},L(e.question),11,le),t("img",{class:"del buttonEffect",src:"./icon/del.png",title:"删除",onClick:y=>B(e)},null,8,oe)]),S(t("br",null,null,512),[[R,!e.fold]]),S(t("div",{class:r({thinking:e.status==="unfinished"}),style:{display:"flex"}},[e.text.length>0?(g(),W(n,{key:0,md:e.text,theme:u(d).settings.theme,style:{width:"0",flex:"1","overflow-x":"auto"}},null,8,["md","theme"])):(g(),_("div",re," ... "))],2),[[R,!e.fold]])],2))),256))],2)],2),t("div",{class:r(["requestArea",{hasContent:l.value.length>0}])},[t("div",{class:r(["request",u(c).type])},[S(t("textarea",{contenteditable:"true",class:r(["requestbox",u(c).type]),"onUpdate:modelValue":a[0]||(a[0]=e=>f.value=e),placeholder:"输入问题，多行输入使用Shift+Enter换行",onKeydown:Z(ee(O,["exact"]),["enter"]),onInput:q,ref_key:"inputTextarea",ref:m},null,42,ae),[[Y,f.value]]),t("div",{class:r(["submitRow",u(c).type])},[t("div",{class:r(["submit",u(c).type,"buttonEffect"]),onClick:O},a[2]||(a[2]=[t("img",{src:"./icon/submit.png",alt:"提问"},null,-1)]),2)],2)],2)],2)],2)}}},de=V(ie,[["__scopeId","data-v-1b8aff3f"]]);export{de as default};
