import{_ as P,g as y,u as V,r as B,d as z,e as K,o as w,c as x,a as n,n as a,f as u,w as E,v as G,h as U,i as X,t as M,F as H,j as Q,k as L,l as W,m as S,p as Y}from"./index-CIzK3A-g.js";const Z={class:"requestArea"},ee={class:"answersArea"},te={class:"question_bar"},se=["title","onClick"],ne=["title"],oe=["onClick"],re={__name:"AskAnswer",setup(le){let A=y().proxy.api,d=y().proxy.config,c=y().proxy.screen;const C=V("answers"),l=B([]),m=B(""),T=z(()=>l.value.every(s=>s.fold));window.chats=l.value;async function g(s=m.value,o=void 0){if(!d.loginStatus.isLogged){S.emit("startLogin",{msg:"请登录后使用",err:!0});return}if(s=s.trim(),s.length<=0)return;let t=Y({question:s,text:"",status:"unfinished",controller:new AbortController,fold:!1}),e="";o?I(o,t):l.value.push(t);let h=[];h.push({role:"user",content:s}),fetch(A.path+"/v1/chat/completions",{signal:t.controller.signal,method:"POST",headers:{Authorization:"Bearer "+d.loginStatus.userinfo.access_token,"Content-Type":"application/json"},body:JSON.stringify({model:"qwen2.5-math-7b-instruct",messages:h,max_tokens:1e3,temperature:1})}).then(i=>{if(i.status===401)fetch(A.path+"/api/token/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:d.loginStatus.userinfo.refresh_token})}).then(r=>{if(!r.ok)throw Error(r.status+": "+r.statusText);return r.json()}).then(r=>{d.loginStatus.userinfo.access_token=r.access_token,g(s,t)}).catch(r=>{e="[登录过期，请重新登录]",t.status="error",S.emit("logout"),S.emit("startLogin",{msg:"登录过期，请重新登录",err:!0}),console.error(r)});else if(!i.ok)throw Error(i.status+": "+i.statusText);const q=i.body.getReader(),D=new TextDecoder;let p="";function j(){q.read().then(({done:r,value:J})=>{if(r){t.status="finished";return}p+=D.decode(J,{stream:!0});let k=0,v=0;for(;v=p.indexOf("}",k)+1,v!=0;)try{let F=JSON.parse(p.substring(0,v));if(F.final){t.status="finished";return}e+=F.choices[0].message.content,p=p.substring(v),k=0}catch{k=v}j()}).catch(r=>{if(r.name==="AbortError"){e="",t.status="finished";return}e+="[解析异常]",t.status="error",console.error(r)})}j()}).catch(i=>{if(i.name==="AbortError"){e="",t.status="finished";return}e+="[请求异常]",t.status="error",console.error(i)});let f=0,N=0,O=0,_="",b=0;N=setInterval(()=>{if(f==1&&C.value.scrollTo(0,Number.MAX_SAFE_INTEGER),f<e.length)_+=e.at(f),++f;else if(t.status!="unfinished"){if(f<e.length){b=0;return}else if(b<5){b++;return}clearInterval(N),t.text=_,clearInterval(O)}},1e3/d.settings.charPerSecond),O=setInterval(()=>{t.text=_},1e3/20)}function I(s,o=void 0){s.controller.abort();let t=l.value.indexOf(s);return o?l.value.splice(t,1,o):l.value.splice(t,1),t}function R(){l.value.forEach(s=>{s.controller.abort()}),l.value.length=0}function $(){T.value?l.value.forEach(s=>{s.fold=!1}):l.value.forEach(s=>{s.fold=!0})}return(s,o)=>{const t=K("Markdown");return w(),x("div",{class:a(["area",u(c).type])},[n("div",Z,[n("div",{class:a(["request",u(c).type])},[E(n("textarea",{contenteditable:"true",class:a(["requestbox",u(c).type]),"onUpdate:modelValue":o[0]||(o[0]=e=>m.value=e),placeholder:"输入问题，多行输入使用Shift+Enter换行",onKeyup:o[1]||(o[1]=U(X(e=>g(),["exact"]),["enter"]))},null,34),[[G,m.value]]),n("div",{class:a(["submitRow",u(c).type])},[n("div",{class:a(["submit",u(c).type,"buttonEffect"]),onClick:o[2]||(o[2]=e=>g())},o[3]||(o[3]=[n("img",{src:"./icon/submit.png",alt:"提问"},null,-1)]),2)],2)],2)]),n("div",ee,[n("div",{class:a(["toolbar",u(c).type])},[n("div",{onClick:R,class:"buttonEffect"},"清空"),n("div",{onClick:$,class:"buttonEffect"},"全部"+M(T.value?"展开":"折叠"),1)],2),n("div",{class:a(["answers",u(c).type]),ref_key:"answers",ref:C},[(w(!0),x(H,null,Q(l.value,e=>(w(),x("div",{class:a(["chat",e.status])},[n("div",te,[n("img",{class:"fold buttonEffect",src:"./icon/fold.png",title:e.fold?"展开":"折叠",onClick:h=>e.fold=!e.fold},null,8,se),n("div",{class:a(["question",{fold:e.fold,thinking:e.fold&&e.status==="unfinished"}]),title:e.question},M(e.question),11,ne),n("img",{class:"del buttonEffect",src:"./icon/del.png",title:"删除",onClick:h=>I(e)},null,8,oe)]),E(n("br",null,null,512),[[L,!e.fold]]),E(n("div",{class:a({thinking:e.status==="unfinished"}),style:{display:"flex"}},[W(t,{md:e.text,theme:u(d).settings.theme,style:{width:"0",flex:"1","overflow-x":"auto"}},null,8,["md","theme"])],2),[[L,!e.fold]])],2))),256))],2)])],2)}}},ie=P(re,[["__scopeId","data-v-c66c23e9"]]);export{ie as default};
