import{_ as ue,g as P,r as O,e as D,f as X,w as de,h as d,i as ce,o as c,c as m,a as i,u as _,t as S,F as $,j as z,n as f,k as se,l as A,v as q,d as fe,b as he,m as ve,p as me,q as ge,s as xe,x as pe}from"./index-D-Opj-al.js";const V=""+new URL("../icon/del.svg",import.meta.url).href,_e=""+new URL("../icon/add.svg",import.meta.url).href,ne=""+new URL("../icon/chat.svg",import.meta.url).href,we=""+new URL("../icon/loading.svg",import.meta.url).href,ye=""+new URL("../icon/submit.svg",import.meta.url).href,ke={class:"area"},Ee={class:"functions"},be=["title"],Ce={class:"chats"},Se=["title","onClick"],Ae=["onClick"],Ie={class:"mainArea"},Te={class:"loading"},Be={class:"question_bar"},qe=["title","onClick"],je={xmlns:"http://www.w3.org/2000/svg","xml:space":"preserve",viewBox:"0 0 1964 1963",overflow:"hidden"},Me=["id"],Ne={fill:"#393C45"},Oe=["title"],De=["onClick"],$e={key:1},ze={key:2,class:"refFiles"},Fe={class:"filesItems"},Le=["title","href"],Re={class:"relQues"},Ue={class:"quesItems"},Ge=["title","onClick"],He=["onKeydown"],Je={__name:"AskAnswer",setup(Pe){let x=P().proxy.api,p=P().proxy.config,w=P().proxy.screen;const a=O(),u=D([]);let E=null;const I=O(),j=O(),K=X(()=>a.value.messages.every(l=>l.fold)),g=O(!1);de(u,()=>{g.value=u.length<=0?!1:g.value});const Y=X(()=>{const l=a.value;if(l.status!="ready")return!0;const t=l.messages;return t.length>0&&t[t.length-1].status=="unfinished"});window.chats=u;let F=X(()=>({Authorization:"Bearer "+p.loginStatus.userinfo.access_token,"Content-Type":"application/json"}));function L(){const l=u.map(s=>s.session_id);function t(){let s=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){let r=(s+Math.random()*16)%16|0;return s=Math.floor(s/16),(o=="x"?r:r&3|8).toString(16)})}let e=t();for(;l.indexOf(e)>=0;)e=t();return E=D({title:"",messages:[],session_id:e,input:"",rel_ques:[],status:"ready"}),console.log(E),E}d.on("loadChats",()=>{Q()}),d.on("clearChats",()=>{u.length=0,a.value=L()}),a.value=L();function Z(l,t=!0){if(a.value=l,l.status=="unload"){let s=function(n){n.forEach(o=>{l.messages.push(D({question:o.question,id:o.question_id,text:o.answer,status:"finished",controller:{abort(){}},fold:!1,ref_files:[]}))}),l.status="ready"},e=F.value;fetch(x.path+"/get_qas?session_id="+l.session_id,{method:"GET",headers:e}).then(n=>n.json()).then(n=>{if(n.code===401)d.emit("refreshToken",{onSuccess(o){e.Authorization="Bearer "+o,fetch(x.path+"/get_qas?session_id="+l.session_id,{method:"GET",headers:e}).then(r=>r.json()).then(r=>{if(r.code!==200)throw Error(r.message||"会话加载失败");s(r.data)}).catch(r=>{d.emit("dialog",{text:r.message}),console.error(r)})}});else if(n.code!==200)throw Error(n.message||"会话加载失败");s(n.data)}).catch(n=>{d.emit("dialog",{text:n.message}),console.error(n)})}w.type=="ver"&&t&&(g.value=!1)}function M(l,t=!1){console.log("删除",l);function e(){let s=u.indexOf(l);u[s]==a.value&&(a.value=E),l.messages.forEach(n=>{n.controller.abort()}),u.splice(s,1),fetch(x.path+"/delete_session/"+l.session_id,{method:"DELETE",headers:F.value})}t?d.emit("dialog",{text:"确定删除该会话吗？",onYes(){e()}}):e()}function le(l=!1){function t(){console.log(u),u.forEach(e=>M(e))}l?d.emit("dialog",{text:"确定清空所有会话吗？",onYes(){t()}}):t()}function Q(){function l(e){let s=!1,n=[];if(le(),e.forEach(o=>{u.push({title:o.name,session_id:o.session_id,timestamp:o.timestamp,messages:[],rel_ques:[],input:"",status:"unload"}),n.push(o.session_id),o.session_id==E.session_id&&(s=!0)}),s){let o=function(){let h=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(k){let C=(h+Math.random()*16)%16|0;return h=Math.floor(h/16),(k=="x"?C:C&3|8).toString(16)})},r=o();for(;n.indexOf(r)>=0;)r=o();E.session_id=r}}if(!p.loginStatus.isLogged)return;let t={Authorization:"Bearer "+p.loginStatus.userinfo.access_token,"Content-Type":"application/json"};fetch(x.path+"/get_sessions",{method:"GET",headers:t}).then(e=>e.json()).then(e=>{if(e.code===401)d.emit("refreshToken",{onSuccess(s){t.Authorization="Bearer "+s,fetch(x.path+"/get_sessions",{method:"GET",headers:t}).then(n=>n.json()).then(n=>{if(n.code!==200)throw Error(n.message||"会话加载失败，请刷新重试");l(n.data||[])}).catch(n=>{d.emit("dialog",{text:n.message}),console.error(n)})}});else{if(e.code!==200)throw Error(e.message||"会话加载失败，请刷新重试");l(e.data||[])}}).catch(e=>{d.emit("dialog",{text:e.message}),console.error(e)})}function R(l=void 0){l!=null&&(a.value.input=l,I.value.value=l),I.value.style.height="auto",I.value.style.height=I.value.scrollHeight+"px"}async function W(l){l.preventDefault();const t=a.value,e=t.messages;e.length>0&&e[e.length-1].status=="unfinished"||await U(t.input)&&(R(""),t.rel_ques.length=0)}async function U(l,t=void 0,e=a.value){if(!p.loginStatus.isLogged)return d.emit("startLogin",{msg:"请登录后使用",err:!0}),!1;if(l=l.trim(),l.length<=0)return!1;let s={Authorization:"Bearer "+p.loginStatus.userinfo.access_token,"Content-Type":"application/json"};if(u.indexOf(e)<0){e.title=l,e.timestamp=new Date().getTime(),e.status="prepost";try{let v=JSON.stringify({session_id:e.session_id,name:e.title});console.log({method:"POST",headers:s,body:v});let b=await fetch(x.path+"/add_session",{method:"POST",headers:s,body:v});if(b=await b.json(),b.code===401)return d.emit("refreshToken",{onSuccess(){U(l,void 0,e)},onFail(){e.status="ready"}}),!0;if(b.code!==201)throw Error(b.message||"会话创建失败，请刷新重试")}catch(v){return d.emit("dialog",{text:v.message}),console.error(v),e.status="ready",!1}e.status="ready",u.push(e),L()}let n=D({question:l,id:null,text:"",status:"unfinished",controller:new AbortController,fold:!1,ref_files:[]}),o="";t?ee(e,t,n):e.messages.push(n);let r=[];r.push({role:"user",content:l}),fetch(x.path+"/v1/chat/completions",{signal:n.controller.signal,method:"POST",headers:s,body:JSON.stringify({session_id:e.session_id,model:"qwen2.5-math-7b-instruct",messages:r,max_tokens:1e3,temperature:1})}).then(v=>{if(v.status===401){d.emit("refreshToken",{onSuccess(){U(l,n,e)},onFail(){o="[登录过期，请重新登录]",n.status="error"}});return}else if(!v.ok)throw Error(v.status+": "+v.statusText);const b=v.body.getReader(),ae=new TextDecoder;let T="";function te(){b.read().then(({done:N,value:re})=>{if(N){n.status="finished";return}T+=ae.decode(re,{stream:!0});let H=0,B=0;for(;B=T.indexOf("}",H)+1,B!=0;)try{let J=JSON.parse(T.substring(0,B));if(n.id=J.id,J.final){n.status="finished",ie(n,e);return}o+=J.choices[0].message.content,T=T.substring(B),H=0}catch{H=B}te()}).catch(N=>{if(N.name==="AbortError"){o="",n.status="finished";return}o+="[解析异常]",n.status="error",console.error(N)})}te()}).catch(v=>{if(v.name==="AbortError"){o="",n.status="finished";return}o+="[请求异常]",n.status="error",console.error(v)});let h=0,y=0,k=0,C="",G=0;return p.settings.printByWord?(y=setInterval(()=>{if(h==1&&setTimeout(()=>j.value.scrollTo(0,Number.MAX_SAFE_INTEGER),500),h<o.length)C+=o.at(h),++h;else if(n.status!="unfinished"){if(h<o.length){G=0;return}else if(G<5){G++;return}clearInterval(y),n.text=C,clearInterval(k)}},1e3/p.settings.charPerSecond),k=setInterval(()=>{n.text=C},1e3/20)):k=setInterval(()=>{n.text=o,h==1&&o.length>0&&setTimeout(()=>j.value.scrollTo(0,Number.MAX_SAFE_INTEGER),500),h++,n.status!="unfinished"&&(n.text=o,clearInterval(k))},1e3/20),!0}function ie(l,t=a.value){fetch(x.path+"/v1/related_questions",{signal:l.controller.signal,method:"POST",headers:{Authorization:"Bearer "+p.loginStatus.userinfo.access_token,"Content-Type":"application/json"},body:JSON.stringify({question:l.question})}).then(e=>{if(e.status!=200)throw Error(e.status+": "+e.statusText);return e.json()}).then(e=>{e.status=="success"&&(t.rel_ques=e.related_questions||[],setTimeout(()=>j.value.scrollTo(0,Number.MAX_SAFE_INTEGER),500))}).catch(e=>{console.error(e)}),fetch(x.path+"/v1/reference_files?question_id="+l.id,{signal:l.controller.signal,method:"GET",headers:{Authorization:"Bearer "+p.loginStatus.userinfo.access_token}}).then(e=>{if(e.status!=200)throw Error(e.status+": "+e.statusText);return e.json()}).then(e=>{e.status=="success"&&(l.ref_files=e.reference_files)}).catch(e=>{console.error(e)})}function ee(l,t,e=void 0,s=!1){function n(o,r,h=void 0){r.controller.abort();let y=o.messages.indexOf(r);if(h)o.messages.splice(y,1,h);else{if(o.messages.length==1){M(o);return}if(r.status!="error"){let k=JSON.stringify({session_id:o.session_id,question_id:o.messages[y].id});fetch(x.path+"/delete_qa",{method:"DELETE",body:k,headers:F.value})}o.messages.splice(y,1)}return y}s&&t.status!="error"?d.emit("dialog",{text:"确认要删除该轮对话？",onYes(){n(l,t,e)}}):n(l,t,e)}function oe(){K.value?a.value.messages.forEach(l=>{l.fold=!1}):a.value.messages.forEach(l=>{l.fold=!0})}return Q(),(l,t)=>{const e=ce("Markdown");return c(),m("div",ke,[i("div",{class:f(["chatsBar",_(w).type,{show:u.length>0,active:g.value}])},[i("div",Ee,[_(w).type=="hor"?(c(),m("div",{key:0,class:"toggleBar buttonEffect",onClick:t[0]||(t[0]=s=>g.value=!g.value),title:g.value?"收回":"展开"},S(g.value?"<":">"),9,be)):(c(),m("div",{key:1,class:"toggleBar buttonEffect",onClick:t[1]||(t[1]=s=>g.value=!1),title:"关闭"},t[8]||(t[8]=[i("img",{src:V,alt:" X"},null,-1)]))),i("div",{class:"addButton buttonEffect",onClick:t[2]||(t[2]=s=>Z(_(E))),title:"创建新会话"},t[9]||(t[9]=[i("img",{src:_e,alt:"add"},null,-1),i("div",null,"创建新会话",-1)]))]),i("div",Ce,[(c(!0),m($,null,z(u,s=>(c(),m("div",{class:f(["buttonEffect","chatItem",{active:a.value==s}]),title:s.title,onClick:n=>Z(s)},[t[10]||(t[10]=i("img",{src:ne,alt:"C",class:"chatIcon"},null,-1)),i("span",null,S(s.title),1),i("img",{src:V,alt:"X",class:"delButton buttonEffect",onClick:se(n=>M(s,!0),["stop"]),title:"删除会话"},null,8,Ae)],10,Se))),256))])],2),A(i("img",{src:ne,alt:"对话",class:"floatChat buttonEffect",onClick:t[3]||(t[3]=s=>g.value=!g.value)},null,512),[[q,_(w).type=="ver"&&u.length>0]]),i("div",Ie,[A(i("div",Te,t[11]||(t[11]=[i("img",{class:"autoInvert",src:we,alt:""},null,-1),fe(" 加载中 ")]),512),[[q,a.value.status=="unload"]]),i("div",{class:f(["startArea",{hasContent:a.value.messages.length>0||a.value.status=="unload"}])},t[12]||(t[12]=[i("div",{class:"title"},[i("img",{src:he,alt:"MathSolve"}),i("span",null,"你的数学解题助手")],-1),i("div",{class:"subtitle"},"一键求解，轻松解决你的数学烦恼",-1)]),2),i("div",{class:f(["answersArea",{hasContent:a.value.messages.length>0||a.value.status=="unload"}])},[i("div",{class:f(["toolbar",_(w).type])},[i("div",{onClick:t[4]||(t[4]=s=>M(a.value,!0)),class:"buttonEffect"},"删除会话"),i("div",{onClick:t[5]||(t[5]=s=>oe()),class:"buttonEffect"},"全部"+S(K.value?"展开":"折叠"),1)],2),i("div",{class:f(["answers",_(w).type]),ref_key:"answers",ref:j},[(c(!0),m($,null,z(a.value.messages,(s,n)=>(c(),m("div",{class:f(["msg",s.status])},[i("div",Be,[i("div",{class:f(["foldButton","buttonEffect",{folded:s.fold}]),title:s.fold?"展开":"折叠",onClick:o=>s.fold=!s.fold},[(c(),m("svg",je,[i("defs",null,[i("mask",{id:"mask"+n},t[13]||(t[13]=[i("rect",{width:"100%",height:"100%",fill:"white"},null,-1),i("path",{class:"turn",stroke:"black","stroke-linejoin":"round","stroke-miterlimit":"10","stroke-width":"150",d:"m982 926 632 791h-319l-313-391-313 391H350Z"},null,-1)]),8,Me)]),i("g",Ne,[i("path",{d:"M287 1174h1390v203H287zM287 786h1390v203H287zM287 398h1390v203H287z",style:ve(`mask:url(#mask${n})`)},null,4),t[14]||(t[14]=i("path",{class:"turn",d:"m982 982 562 702h-284l-278-347-278 347H420Z"},null,-1))])]))],10,qe),i("div",{class:f(["question",{folded:s.fold,thinking:s.fold&&s.status==="unfinished"}]),title:s.question},S(s.question),11,Oe),i("img",{class:"delButton buttonEffect",src:V,title:"删除",onClick:o=>ee(a.value,s)},null,8,De)]),A(i("br",null,null,512),[[q,!s.fold]]),A(i("div",{class:f({foldable:!0,thinking:s.status==="unfinished"}),style:{display:"flex"}},[s.text.length>0?(c(),me(e,{key:0,md:s.text,theme:_(p).settings.theme},null,8,["md","theme"])):(c(),m("div",$e," ... ")),s.ref_files.length>0?(c(),m("div",ze,[t[15]||(t[15]=i("div",{class:"filesTitle"},"... 参考文档 ...",-1)),i("div",Fe,[(c(!0),m($,null,z(s.ref_files,o=>(c(),m("a",{class:"filesItem",title:o.name,href:o.url,target:"_blank"},S(o.name),9,Le))),256))])])):ge("",!0)],2),[[q,!s.fold]])],2))),256)),A(i("div",Re,[t[16]||(t[16]=i("div",{class:"quesTitle"},"继续提问：",-1)),i("div",Ue,[(c(!0),m($,null,z(a.value.rel_ques,s=>(c(),m("div",{class:"quesItem buttonEffect",title:s,onClick:n=>R(s)},S(s),9,Ge))),256))])],512),[[q,a.value.rel_ques.length>0]])],2)],2),i("div",{class:f(["requestArea",{hasContent:a.value.messages.length>0||a.value.status=="unload"}])},[i("div",{class:f(["request",_(w).type])},[A(i("textarea",{contenteditable:"true",class:f(["requestbox",_(w).type]),"onUpdate:modelValue":t[6]||(t[6]=s=>a.value.input=s),placeholder:"输入问题，多行输入使用Shift+Enter换行",onKeydown:pe(se(W,["exact"]),["enter"]),onInput:t[7]||(t[7]=s=>R()),ref_key:"inputTextarea",ref:I},null,42,He),[[xe,a.value.input]]),i("div",{class:f(["submitRow",_(w).type])},[i("img",{class:f(["submit",{buttonEffect:!Y.value,disable:Y.value}]),src:ye,alt:"提问",onClick:W},null,2)],2)],2)],2)])])}}},Ve=ue(Je,[["__scopeId","data-v-b808d508"]]);export{Ve as default};
