import{_ as O,g as z,e as d,r as P,I as N,c as x,o as _,j as W,J as X,i as t,u as l,t as A,l as b,s as i,L as D,w as v,v as L,A as C,n as k,T as Y}from"./index-sFl1wKch.js";const Z={key:0,class:"preview-mode"},H={class:"user-profile"},J={class:"avatar-container"},q=["src"],G={class:"user-details"},K={class:"detail-item"},Q={class:"value"},ee={class:"detail-item"},te={class:"value"},se={class:"action-buttons"},oe={class:"danger-zone"},ae={key:1,class:"edit-mode"},ne={class:"edit-section"},le={class:"avatar-upload"},ie={class:"current-avatar"},re=["src"],de={class:"upload-overlay drag"},ue={class:"form-group"},pe={class:"submit-section"},ce=["disabled"],me={class:"edit-section"},ve={class:"form-group"},fe={class:"form-group"},ge={class:"submit-section"},we=["disabled"],be={class:"action-buttons"},R=16,he={__name:"UserInfo",setup(ye){const h=z(),n=h.proxy.config.loginStatus.userinfo,F=h.proxy.screen,f=h.proxy.F,g=d("preview"),U=d(),s=P({name:n.name,photo:n.photo,pswd1:"",pswd2:""});let r=null,p=0;const c=d(!1),y=d(!1);function $(o){p++,o.target===o.currentTarget&&(c.value=!0)}function I(o){p--;const e=o.currentTarget.getBoundingClientRect();(o.clientX<=e.left||o.clientX>=e.right||o.clientY<=e.top||o.clientY>=e.bottom)&&(p=0),p===0&&(c.value=!1)}function S(o){p=0,c.value=!1,r=o.dataTransfer.files[0],r.type.startsWith("image")&&(URL.revokeObjectURL(s.photo),s.photo=URL.createObjectURL(r))}function j(o){r=o.target.files[0],!(!r||!r.type.startsWith("image"))&&(URL.revokeObjectURL(s.photo),s.photo=URL.createObjectURL(r))}async function E(){if(!w.value||!u.value)return;u.value=!1;let o={};if(s.photo!==n.photo){let a=new FormData;a.append("photo",r);let T=await f.myFetchApi("/upload_image",{expectCodes:[200,201],errorText:"头像上传失败"},{data:a});if(!T){u.value=!0;return}o.photo=T.data}s.name!==n.name&&(o.name=s.name);let e=await f.myFetchApi("/update_info",{expectCodes:[200],errorText:"信息更新失败"},{method:"PUT",json:o});e&&(i.emit("refreshUserInfo"),i.emit("dialog",{text:e.message})),u.value=!0}const M=/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@#$%^&*!]{8,16}$/;async function V(){if(!m.value)return;if(s.pswd1!==s.pswd2){i.emit("dialog",{text:"两次输入的密码不一致!"});return}if(!M.test(s.pswd1)){i.emit("dialog",{text:"密码长度须为8-16个字符，至少包含1个字母和1个数字，可包含特殊字符(@#$%^&*)"});return}m.value=!1;let o=await f.myFetchApi("/change_password",{expectCodes:[200],errorText:"密码修改失败"},{method:"PUT",json:{password:s.pswd1}});o&&(s.pswd1=s.pswd2="",i.emit("dialog",{text:o.message})),m.value=!0}function B(){i.emit("dialog",{text:"确认要注销账号吗？",onYes(){f.myFetchApi("/cancel_account",{expectCodes:[200],errorText:"注销失败!"},{method:"DELETE"}).then(o=>{o&&(i.emit("dialog",{text:o.message}),i.emit("logout"))})},type:"yes_no"})}let w=d(!1),u=d(!0),m=d(!0);return N(()=>{w.value=s.name!==n.name||s.photo!==n.photo}),window.addEventListener("hashchange",()=>{g.value="preview",s.photo=n.photo,s.name=n.name,s.pswd1=s.pswd2=""}),(o,e)=>(_(),x("div",{class:k(["user-info-container",l(F).type])},[W(Y,{name:"fade",mode:"out-in"},{default:X(()=>[g.value==="preview"?(_(),x("div",Z,[e[15]||(e[15]=t("div",{class:"section-header"},[t("h2",null,"个人信息")],-1)),t("div",H,[t("div",J,[t("img",{src:l(n).photo,class:"avatar",alt:"用户头像"},null,8,q)]),t("div",G,[t("div",K,[e[10]||(e[10]=t("span",{class:"label"},"昵称",-1)),t("span",Q,A(l(n).name),1)]),t("div",ee,[e[11]||(e[11]=t("span",{class:"label"},"用户名",-1)),t("span",te,A(l(n).username),1)])])]),t("div",se,[t("button",{class:"btn primary",onClick:e[0]||(e[0]=a=>g.value="edit")},e[12]||(e[12]=[t("i",{class:"fas fa-edit"},null,-1),b(" 编辑信息 ")]))]),e[16]||(e[16]=t("div",{class:"section-header"},[t("h2",null,"其他操作")],-1)),t("div",oe,[t("button",{class:"btn danger",onClick:e[1]||(e[1]=a=>l(i).emit("delAllChats"))},e[13]||(e[13]=[t("i",{class:"fas fa-trash"},null,-1),b(" 删除所有会话 ")])),t("button",{class:"btn danger",onClick:B},e[14]||(e[14]=[t("i",{class:"fas fa-user-times"},null,-1),b(" 注销账号 ")]))])])):(_(),x("div",ae,[e[23]||(e[23]=t("div",{class:"section-header"},[t("h2",null,"基本信息")],-1)),t("div",ne,[t("div",le,[t("div",ie,[t("img",{src:s.photo,alt:"当前头像"},null,8,re)]),t("div",{class:"upload-area",onDragenter:$,onDragover:e[3]||(e[3]=D(()=>{},["prevent"])),onDrop:D(S,["prevent"]),onDragleave:I,onMouseenter:e[4]||(e[4]=a=>y.value=!0),onMouseleave:e[5]||(e[5]=a=>y.value=!1)},[e[19]||(e[19]=b(" 点击/拖拽上传头像 ")),t("input",{type:"file",ref_key:"imageSelector",ref:U,accept:"image/*",onChange:j,class:"hidden-input"},null,544),v(t("div",{class:"upload-overlay click",onClick:e[2]||(e[2]=a=>U.value.click())},e[17]||(e[17]=[t("i",{class:"fas fa-cloud-upload-alt"},null,-1),t("span",null,"点击上传",-1)]),512),[[L,!c.value&&y.value]]),v(t("div",de,e[18]||(e[18]=[t("i",{class:"fas fa-cloud-upload-alt"},null,-1),t("span",null,"拖拽上传",-1)]),512),[[L,c.value]])],32)]),t("div",ue,[e[20]||(e[20]=t("label",null,"昵称",-1)),v(t("input",{type:"text","onUpdate:modelValue":e[6]||(e[6]=a=>s.name=a),maxlength:"20",class:"form-input",placeholder:"请输入昵称"},null,512),[[C,s.name]])]),t("div",pe,[t("button",{class:k(["btn primary",{disabled:!l(w)||!l(u)}]),disabled:!l(w)||!l(u),onClick:E}," 保存修改 ",10,ce)])]),e[24]||(e[24]=t("div",{class:"section-header"},[t("h2",null,"修改密码")],-1)),t("div",me,[t("div",ve,[e[21]||(e[21]=t("label",null,"新密码",-1)),v(t("input",{type:"password","onUpdate:modelValue":e[7]||(e[7]=a=>s.pswd1=a),maxlength:R,class:"form-input",placeholder:"请输入新密码"},null,512),[[C,s.pswd1]])]),t("div",fe,[e[22]||(e[22]=t("label",null,"确认密码",-1)),v(t("input",{type:"password","onUpdate:modelValue":e[8]||(e[8]=a=>s.pswd2=a),maxlength:R,class:"form-input",placeholder:"请再次输入新密码"},null,512),[[C,s.pswd2]])]),t("div",ge,[t("button",{class:k(["btn primary",{disabled:!l(m)}]),disabled:!l(m),onClick:V}," 修改密码 ",10,we)])]),t("div",be,[t("button",{class:"btn secondary",onClick:e[9]||(e[9]=a=>g.value="preview")}," 返回 ")])]))]),_:1})],2))}},_e=O(he,[["__scopeId","data-v-d820197f"]]);export{_e as default};
