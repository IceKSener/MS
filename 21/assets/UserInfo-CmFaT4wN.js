import{_ as O,g as b,f as d,k as _,l as T,o as k,c as S,e as P,m as N,n as v,u as l,a as e,t as A,p as a,q as D,w as g,j as R,v as C,i as W,T as X}from"./index-DHhb6ltM.js";const Y={class:"info"},Z=["src"],q={class:"names"},H={class:"name"},G={class:"n2"},J={class:"name"},K={class:"n2"},Q={class:"item image"},tt={class:"imageArea"},et=["src"],st={class:"drag"},it={class:"item text"},nt={class:"submitLine"},ot={class:"item text"},lt={class:"item text"},at={class:"submitLine"},$=16,rt={__name:"UserInfo",setup(dt){let o=b().proxy.config,x=b().proxy.screen,c=b().proxy.F;const u=d("preview");d({});const U=d(),s=_({name:o.loginStatus.userinfo.name,photo:o.loginStatus.userinfo.photo,pswd1:"",pswd2:""});let r=null,p=0;const m=d(!1),y=d(!1);function F(i){p++,i.target==i.currentTarget&&(m.value=!0)}function j(i){p--;const t=i.currentTarget.getBoundingClientRect();(i.clientX<=t.left||i.clientX>=t.right||i.clientY<=t.top||i.clientY>=t.bottom)&&(p=0),p===0&&(m.value=!1)}function z(i){p=0,m.value=!1,r=i.dataTransfer.files[0],r.type.startsWith("image")&&(URL.revokeObjectURL(s.photo),s.photo=URL.createObjectURL(r))}function B(i){r=i.target.files[0],!(!r||!r.type.startsWith("image"))&&(URL.revokeObjectURL(s.photo),s.photo=URL.createObjectURL(r))}async function I(){if(!h.value||!f.value)return;f.value=!1;let i={};if(s.photo!==o.loginStatus.userinfo.photo){let n=new FormData;n.append("photo",r);let L=await c.myFetchApi("/upload_image",{expectCodes:[201],errorText:"头像上传失败"},{data:n});if(!L){f.value=!0;return}i.photo=L.data}s.name!==o.loginStatus.userinfo.name&&(i.name=s.name);let t=await c.myFetchApi("/update_info",{expectCodes:[200],errorText:"信息更新失败"},{method:"PUT",json:i});t&&(a.emit("refreshUserInfo"),a.emit("dialog",{text:t.message})),f.value=!0}const E=/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@#$%^&*!]{8,16}$/;async function M(){if(!w.value)return;if(s.pswd1!==s.pswd2){a.emit("dialog",{text:"两次输入的密码不一致!"});return}if(!E.test(s.pswd1)){a.emit("dialog",{text:`密码长度须为8-16个字符，至少包含1个字母和
1个数字，可包含特殊字符(@#$%^&*)`});return}w.value=!1;let i=await c.myFetchApi("/change_password",{expectCodes:[200],errorText:"密码修改失败"},{method:"PUT",json:{password:s.pswd1}});i&&(s.pswd1=s.pswd2="",a.emit("dialog",{text:i.message})),w.value=!0}function V(){a.emit("dialog",{text:"确认要注销账号吗？",onYes(){c.myFetchApi("/cancel_account",{expectCodes:[200],errorText:"注销失败!"},{method:"DELETE"}).then(i=>{i&&(a.emit("dialog",{text:i.message}),a.emit("logout"))})},type:"yes_no"})}T(()=>{s.photo=o.loginStatus.userinfo.photo,s.name=o.loginStatus.userinfo.name});let h=d(!1),f=d(!0),w=d(!0);return T(()=>h.value=s.name!==o.loginStatus.userinfo.name||s.photo!==o.loginStatus.userinfo.photo),window.addEventListener("hashchange",()=>{u.value="preview",s.photo=o.loginStatus.userinfo.photo,s.name=o.loginStatus.userinfo.name,s.pswd1=s.pswd2=""}),(i,t)=>(k(),S("div",{class:v(["area",l(x).type])},[P(X,{name:"fade"},{default:N(()=>[u.value==="preview"?(k(),S("div",{key:0,class:v(["preview",l(x).type])},[t[13]||(t[13]=e("div",{class:"title"},"我的信息",-1)),e("div",Y,[e("img",{class:"photo",src:l(o).loginStatus.userinfo.photo},null,8,Z),e("div",q,[e("div",H,[t[11]||(t[11]=e("span",{class:"n1"},"我的昵称:",-1)),e("span",G,A(l(o).loginStatus.userinfo.name),1)]),e("div",J,[t[12]||(t[12]=e("span",{class:"n1"},"用户名:",-1)),e("span",K,A(l(o).loginStatus.userinfo.username),1)])])]),e("div",{class:"button",onClick:t[0]||(t[0]=n=>u.value="edit")},"编辑信息"),t[14]||(t[14]=e("hr",{style:{width:"100%"}},null,-1)),t[15]||(t[15]=e("div",{class:"title"},"其他",-1)),e("div",{class:"button del",onClick:t[1]||(t[1]=n=>l(a).emit("delAllChats"))},"删除所有会话"),e("div",{class:"button del",onClick:t[2]||(t[2]=n=>V())},"注销账号")],2)):u.value==="edit"?(k(),S("div",{key:1,class:v(["edit",l(x).type])},[t[22]||(t[22]=e("div",{class:"title"},"基本信息",-1)),e("div",Q,[t[18]||(t[18]=e("div",{class:"text"},"当前头像",-1)),e("div",tt,[e("img",{class:"image",src:s.photo},null,8,et),e("div",{class:"input",onDragenter:F,onDragover:t[4]||(t[4]=D(()=>{},["prevent"])),onDrop:D(z,["prevent"]),onDragleave:j,onMouseenter:t[5]||(t[5]=n=>y.value=!0),onMouseleave:t[6]||(t[6]=n=>y.value=!1)},[g(e("div",{class:"click",onClick:t[3]||(t[3]=n=>U.value.click())},[e("input",{type:"file",style:{display:"none"},ref_key:"imageSelector",ref:U,accept:"image/*",onChange:B},null,544),t[16]||(t[16]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"200",height:"200"},[e("text",{x:"100",y:"100",fill:"none",stroke:"#000","stroke-width":"4","font-size":"20",style:{"text-anchor":"middle","dominant-baseline":"middle"}},"点击上传文件"),e("text",{x:"100",y:"100",fill:"#fff","font-size":"20",style:{"text-anchor":"middle","dominant-baseline":"middle"}},"点击上传文件")],-1))],512),[[R,!m.value&&y.value]]),g(e("div",st,t[17]||(t[17]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"200",height:"200"},[e("text",{x:"100",y:"100",fill:"none",stroke:"#000","stroke-width":"4","font-size":"20",style:{"text-anchor":"middle","dominant-baseline":"middle"}},"拖拽上传文件"),e("text",{x:"100",y:"100",fill:"#fff","font-size":"20",style:{"text-anchor":"middle","dominant-baseline":"middle"}},"拖拽上传文件")],-1)]),512),[[R,m.value]])],32)])]),e("div",it,[t[19]||(t[19]=e("div",{class:"text"},"我的昵称:",-1)),g(e("input",{type:"text",class:"input",maxlength:"20","onUpdate:modelValue":t[7]||(t[7]=n=>s.name=n)},null,512),[[C,s.name]])]),e("div",nt,[e("div",{class:v(["submitButton",{enable:l(h)&&l(f)}]),onClick:I},"提交",2)]),t[23]||(t[23]=e("div",{class:"title"},"修改密码",-1)),e("div",ot,[t[20]||(t[20]=e("div",{class:"text"},"新密码:",-1)),g(e("input",{type:"password",maxlength:$,class:"input","onUpdate:modelValue":t[8]||(t[8]=n=>s.pswd1=n)},null,512),[[C,s.pswd1]])]),e("div",lt,[t[21]||(t[21]=e("div",{class:"text"},"确认新密码:",-1)),g(e("input",{type:"password",maxlength:$,class:"input","onUpdate:modelValue":t[9]||(t[9]=n=>s.pswd2=n)},null,512),[[C,s.pswd2]])]),e("div",at,[e("div",{class:v(["submitButton",{enable:l(w)}]),onClick:M},"修改",2)]),e("div",{class:"button",onClick:t[10]||(t[10]=n=>u.value="preview"),style:{width:"400px"}},"取消")],2)):W("",!0)]),_:1})],2))}},pt=O(rt,[["__scopeId","data-v-1b5f93b1"]]);export{pt as default};
