import{_ as ce,g as V,r as O,e as R,f as le,w as he,h as d,i as ve,o as f,c as h,a as o,u as g,t as E,F as U,j as D,n as c,k as ie,l as T,v as N,d as me,b as xe,m as X,p as ge,q as _e,s as pe,x as we}from"./index-BxJGlRxB.js";const P=""+new URL("../icon/del.svg",import.meta.url).href,ke=""+new URL("../icon/add.svg",import.meta.url).href,oe=""+new URL("../icon/chat.svg",import.meta.url).href,ye=""+new URL("../icon/loading.svg",import.meta.url).href,be=""+new URL("../icon/submit.svg",import.meta.url).href,Ee={class:"area"},Ce={class:"functions"},Se=["title"],Ae={class:"chats"},qe=["title","onClick"],Ie=["onClick"],Be={class:"mainArea"},Te={class:"question_bar"},je=["title","onClick"],$e={xmlns:"http://www.w3.org/2000/svg","xml:space":"preserve",viewBox:"0 0 1964 1963",overflow:"hidden"},Le=["id"],Oe={fill:"#393C45"},Re=["title"],Ue=["onClick"],De={key:1},Ne={key:2,class:"refFiles"},Me=["onClick"],Fe=["title","href"],ze={class:"relQues"},Ge={class:"quesItems"},He=["title","onClick"],Je=["onKeydown"],Ve={__name:"AskAnswer",setup(Xe){let p=V().proxy.api,x=V().proxy.config,w=V().proxy.screen;const K=Blob&&URL.createObjectURL&&URL.revokeObjectURL,a=O(),u=R([]);let C=null;const q=O(),j=O(),Q=le(()=>a.value.messages.every(l=>l.fold)),_=O(!1);he(u,()=>{_.value=u.length<=0?!1:_.value});const Y=le(()=>{const l=a.value;if(l.status!="ready")return!0;const n=l.messages;return n.length>0&&n[n.length-1].status=="unfinished"});window.chats=u;let S=()=>({Authorization:"Bearer "+x.loginStatus.userinfo.access_token,"Content-Type":"application/json"});function $(){const l=u.map(t=>t.session_id);function n(){let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(i){let r=(t+Math.random()*16)%16|0;return t=Math.floor(t/16),(i=="x"?r:r&3|8).toString(16)})}let e=n();for(;l.indexOf(e)>=0;)e=n();return C=R({title:"",messages:[],session_id:e,input:"",rel_ques:[],status:"ready"}),C}d.on("loadChats",()=>{W()}),d.on("clearChats",()=>{u.length=0,a.value=$()}),d.on("clearChats",()=>{u.length=0,a.value=$()}),d.on("delAllChats",()=>{ae(!0)}),a.value=$();function Z(l,n=!0){if(a.value=l,l.status=="unload"){let t=function(s){s.forEach(i=>{l.messages.push(R({question:i.question,id:i.question_id,text:i.answer,status:"finished",controller:{abort(){}},fold:!1,ref_files:[],ref_show:!1}))}),l.status="ready"},e=S();fetch(p.path+"/get_qas?session_id="+l.session_id,{method:"GET",headers:e}).then(s=>s.json()).then(s=>{if(s.code===401){d.emit("refreshToken",{onSuccess(i){e.Authorization="Bearer "+i,fetch(p.path+"/get_qas?session_id="+l.session_id,{method:"GET",headers:e}).then(r=>r.json()).then(r=>{if(r.code!==200)throw Error(r.code?r.message:"会话加载失败");t(r.data)}).catch(r=>{d.emit("dialog",{text:r.message}),console.error(r)})}});return}else if(s.code!==200)throw Error(s.code?s.message:"会话加载失败");t(s.data)}).catch(s=>{d.emit("dialog",{text:s.message}),console.error(s)})}w.type=="ver"&&n&&(_.value=!1)}function M(l,n=!1){function e(){let t=u.indexOf(l);u[t]==a.value&&(a.value=C),l.messages.forEach(s=>{s.controller.abort()}),u.splice(t,1),fetch(p.path+"/delete_session/"+l.session_id,{method:"DELETE",headers:S()})}n&&x.settings.comfBefDelSess?d.emit("dialog",{text:"确定删除该会话吗？",onYes(t){x.settings.comfBefDelSess=t,e()},checkText:"每次删除都提示确认",checkVal:!0}):e()}function ae(l=!1){function n(){for(;u.length>0;)M(u[0])}l?d.emit("dialog",{text:"确定清空所有会话吗？",onYes(){n()}}):n()}function W(){function l(e){let t=!1,s=[];if(u.length=0,e.forEach(i=>{u.push({title:i.name,session_id:i.session_id,timestamp:i.timestamp,messages:[],rel_ques:[],input:"",status:"unload"}),s.push(i.session_id),i.session_id==C.session_id&&(t=!0)}),t){let i=function(){let v=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(y){let A=(v+Math.random()*16)%16|0;return v=Math.floor(v/16),(y=="x"?A:A&3|8).toString(16)})},r=i();for(;s.indexOf(r)>=0;)r=i();C.session_id=r}a.value=C}if(!x.loginStatus.isLogged)return;let n=S();fetch(p.path+"/get_sessions",{method:"GET",headers:n}).then(e=>e.json()).then(e=>{if(e.code===401)d.emit("refreshToken",{onSuccess(t){n.Authorization="Bearer "+t,fetch(p.path+"/get_sessions",{method:"GET",headers:n}).then(s=>s.json()).then(s=>{if(s.code!==200)throw Error(s.code?s.message:"会话加载失败，请刷新重试");l(s.data||[])}).catch(s=>{d.emit("dialog",{text:s.message}),console.error(s)})}});else{if(e.code!==200)throw Error(e.code?e.message:"会话加载失败，请刷新重试");l(e.data||[])}}).catch(e=>{d.emit("dialog",{text:e.message}),console.error(e)})}function F(l=void 0){l!=null&&(a.value.input=l,q.value.value=l),q.value.style.height="auto",q.value.style.height=q.value.scrollHeight+"px"}async function ee(l){l.preventDefault();const n=a.value,e=n.messages;e.length>0&&e[e.length-1].status=="unfinished"||await z(n.input)&&(F(""),n.rel_ques.length=0)}async function z(l,n=void 0,e=a.value){if(!x.loginStatus.isLogged)return d.emit("startLogin",{msg:"请登录后使用",err:!0}),!1;if(l=l.trim(),l.length<=0)return!1;let t=S();if(u.indexOf(e)<0){e.title=l,e.timestamp=new Date().getTime(),e.status="prepost";try{let m=JSON.stringify({session_id:e.session_id,name:e.title}),b=await fetch(p.path+"/add_session",{method:"POST",headers:t,body:m});if(b=await b.json(),b.code===401)return d.emit("refreshToken",{onSuccess(){z(l,void 0,e)},onFail(){e.status="ready"}}),!0;if(b.code!==201)throw Error(b.code?b.message:"会话创建失败，请刷新重试")}catch(m){return d.emit("dialog",{text:m.message}),console.error(m),e.status="ready",!1}e.status="ready",u.push(e),$()}let s=R({question:l,id:null,text:"",status:"unfinished",controller:new AbortController,fold:!1,ref_files:[],ref_show:!1}),i="";n?te(e,n,s):e.messages.push(s);let r=[];r.push({role:"user",content:l}),fetch(p.path+"/v1/chat/completions",{signal:s.controller.signal,method:"POST",headers:t,body:JSON.stringify({session_id:e.session_id,model:"qwen2.5-math-7b-instruct",messages:r,max_tokens:1e3,temperature:x.settings.temperature})}).then(m=>{if(m.status===401){d.emit("refreshToken",{onSuccess(){z(l,s,e)},onFail(){i="[登录过期，请重新登录]",s.status="error"}});return}else if(!m.ok)throw Error(m.status+": "+m.statusText);const b=m.body.getReader(),de=new TextDecoder;let I="";function ne(){b.read().then(({done:L,value:fe})=>{if(L){s.status="finished";return}I+=de.decode(fe,{stream:!0});let H=0,B=0;for(;B=I.indexOf("}",H)+1,B!=0;)try{let J=JSON.parse(I.substring(0,B));if(s.id=J.id,J.final){s.status="finished",re(s,e);return}i+=J.choices[0].message.content,I=I.substring(B),H=0}catch{H=B}ne()}).catch(L=>{if(L.name==="AbortError"){i="",s.status="finished";return}i+="[解析异常]",s.status="error",console.error(L)})}ne()}).catch(m=>{if(m.name==="AbortError"){i="",s.status="finished";return}i+="[请求异常]",s.status="error",console.error(m)});let v=0,k=0,y=0,A="",G=0;return x.settings.printByWord?(k=setInterval(()=>{if(v==1&&setTimeout(()=>j.value.scrollTo(0,Number.MAX_SAFE_INTEGER),500),v<i.length)A+=i.at(v),++v;else if(s.status!="unfinished"){if(v<i.length){G=0;return}else if(G<5){G++;return}clearInterval(k),s.text=A,clearInterval(y)}},1e3/x.settings.charPerSecond),y=setInterval(()=>{s.text=A},1e3/20)):y=setInterval(()=>{s.text=i,v==1&&i.length>0&&setTimeout(()=>j.value.scrollTo(0,Number.MAX_SAFE_INTEGER),500),v++,s.status!="unfinished"&&(s.text=i,clearInterval(y))},1e3/20),!0}function re(l,n=a.value){fetch(p.path+"/v1/related_questions",{signal:l.controller.signal,method:"POST",headers:S(),body:JSON.stringify({question:l.question})}).then(e=>{if(e.status!=200)throw Error(e.status+": "+e.statusText);return e.json()}).then(e=>{e.status=="success"&&(n.rel_ques=e.related_questions||[],setTimeout(()=>j.value.scrollTo(0,Number.MAX_SAFE_INTEGER),500))}).catch(e=>{console.error(e)}),fetch(p.path+"/v1/reference_files?question_id="+l.id,{signal:l.controller.signal,method:"GET",headers:{Authorization:"Bearer "+x.loginStatus.userinfo.access_token}}).then(e=>{if(e.status!=200)throw Error(e.status+": "+e.statusText);return e.json()}).then(e=>{e.status=="success"&&(l.ref_files=e.reference_files)}).catch(e=>{console.error(e)})}function te(l,n,e=void 0,t=!1){function s(i,r,v=void 0){r.controller.abort();let k=i.messages.indexOf(r);if(v)i.messages.splice(k,1,v);else{if(i.messages.length==1){M(i);return}if(r.status!="error"){let y=JSON.stringify({session_id:i.session_id,question_id:i.messages[k].id});fetch(p.path+"/delete_qa",{method:"DELETE",body:y,headers:S()})}i.messages.splice(k,1)}return k}t&&x.settings.comfBefDelQues&&n.status!="error"?d.emit("dialog",{text:"确认要删除该轮提问？",onYes(i){x.settings.comfBefDelQues=i,s(l,n,e)},checkText:"每次删除都提示确认",checkVal:!0}):s(l,n,e)}function ue(){Q.value?a.value.messages.forEach(l=>{l.fold=!1}):a.value.messages.forEach(l=>{l.fold=!0})}function se(l,n){if(l.messages.length<=0)return;let e=null,t="";if(n==="markdown")t=".md",e="",l.messages.forEach(s=>{s.status=="finished"&&(e+=`**${s.question}**

`,e+=s.text+`

`,s.ref_files.length>0&&(e+="`参考文档`\n\n",s.ref_files.forEach(i=>{e+=`#### [*${i.name}*](${i.url})

`})),e+=`---

`)});else if(n==="json"){t=".json";let s=l.messages.filter(r=>r.status=="finished").map(r=>({question:r.question,question_id:r.id,answer:r.text,timestamp:r.timestamp,reference_files:r.ref_files})),i={name:l.title,session_id:l.session_id,questions:s};e=JSON.stringify(i)}if(e){let s=document.createElement("a");e=new Blob([e]);let i=URL.createObjectURL(e);s.href=i,s.download=`${l.session_id}${t}`,s.click(),URL.revokeObjectURL(i)}}return W(),(l,n)=>{const e=ve("Markdown");return f(),h("div",Ee,[o("div",{class:c(["chatsBar",g(w).type,{show:u.length>0,active:_.value}])},[o("div",Ce,[g(w).type=="hor"?(f(),h("div",{key:0,class:"toggleBar buttonEffect",onClick:n[0]||(n[0]=t=>_.value=!_.value),title:_.value?"收回":"展开"},E(_.value?"<":">"),9,Se)):(f(),h("div",{key:1,class:"toggleBar buttonEffect",onClick:n[1]||(n[1]=t=>_.value=!1),title:"关闭"},n[9]||(n[9]=[o("img",{src:P,alt:" X"},null,-1)]))),o("div",{class:"addButton buttonEffect",onClick:n[2]||(n[2]=t=>Z(g(C))),title:"创建新会话"},n[10]||(n[10]=[o("img",{src:ke,alt:"add"},null,-1),o("div",null,"创建新会话",-1)]))]),o("div",Ae,[(f(!0),h(U,null,D(u,t=>(f(),h("div",{class:c(["buttonEffect","chatItem",{active:a.value==t}]),title:t.title,onClick:s=>Z(t)},[n[11]||(n[11]=o("img",{src:oe,alt:"C",class:"chatIcon"},null,-1)),o("span",null,E(t.title),1),o("img",{src:P,alt:"X",class:"delButton buttonEffect",onClick:ie(s=>M(t,!0),["stop"]),title:"删除会话"},null,8,Ie)],10,qe))),256))])],2),T(o("img",{src:oe,alt:"对话",class:"floatChat buttonEffect",onClick:n[3]||(n[3]=t=>_.value=!_.value)},null,512),[[N,g(w).type=="ver"&&u.length>0]]),o("div",Be,[o("div",{class:c(["loading",{show:a.value.status=="unload"}])},n[12]||(n[12]=[o("img",{class:"autoInvert",src:ye,alt:""},null,-1),me(" 加载中 ")]),2),o("div",{class:c(["startArea",{hasContent:a.value.messages.length>0||a.value.status=="unload"}])},n[13]||(n[13]=[o("div",{class:"title"},[o("img",{src:xe,alt:"MathSolve"}),o("span",null,"你的数学解题助手")],-1),o("div",{class:"subtitle"},"一键求解，轻松解决你的数学烦恼",-1)]),2),o("div",{class:c(["answersArea",{hasContent:a.value.messages.length>0||a.value.status=="unload"}])},[o("div",{class:c(["toolbar",g(w).type])},[g(K)?(f(),h("div",{key:0,onClick:n[4]||(n[4]=t=>se(a.value,"markdown")),class:"buttonEffect"},"导出会话.md")):X("",!0),g(K)?(f(),h("div",{key:1,onClick:n[5]||(n[5]=t=>se(a.value,"json")),class:"buttonEffect"},"导出会话.json")):X("",!0),o("div",{onClick:n[6]||(n[6]=t=>ue()),class:"buttonEffect"},"全部"+E(Q.value?"展开":"折叠"),1)],2),o("div",{class:c(["answers",g(w).type]),ref_key:"answers",ref:j},[(f(!0),h(U,null,D(a.value.messages,(t,s)=>(f(),h("div",{class:c(["msg",t.status])},[o("div",Te,[o("div",{class:c(["foldButton","buttonEffect",{folded:t.fold}]),title:t.fold?"展开":"折叠",onClick:i=>t.fold=!t.fold},[(f(),h("svg",$e,[o("defs",null,[o("mask",{id:"mask"+s},n[14]||(n[14]=[o("rect",{width:"100%",height:"100%",fill:"white"},null,-1),o("path",{class:"turn",stroke:"black","stroke-linejoin":"round","stroke-miterlimit":"10","stroke-width":"150",d:"m982 926 632 791h-319l-313-391-313 391H350Z"},null,-1)]),8,Le)]),o("g",Oe,[o("path",{d:"M287 1174h1390v203H287zM287 786h1390v203H287zM287 398h1390v203H287z",style:ge(`mask:url(#mask${s})`)},null,4),n[15]||(n[15]=o("path",{class:"turn",d:"m982 982 562 702h-284l-278-347-278 347H420Z"},null,-1))])]))],10,je),o("div",{class:c(["question",{folded:t.fold,thinking:t.fold&&t.status==="unfinished"}]),title:t.question},E(t.question),11,Re),o("img",{class:"delButton buttonEffect",src:P,title:"删除",onClick:i=>te(a.value,t,void 0,!0)},null,8,Ue)]),T(o("br",null,null,512),[[N,!t.fold]]),T(o("div",{class:c({foldable:!0,thinking:t.status==="unfinished"}),style:{display:"flex"}},[t.text.length>0?(f(),_e(e,{key:0,md:t.text,theme:g(x).settings.theme},null,8,["md","theme"])):(f(),h("div",De," ... ")),t.ref_files.length>0?(f(),h("div",Ne,[o("div",{class:"filesTitle buttonEffect",onClick:i=>t.ref_show=!t.ref_show},E(t.ref_show?"∧":"∨")+" 参考文档 "+E(t.ref_show?"∧":"∨"),9,Me),o("div",{class:c(["filesItems",{show:t.ref_show}])},[(f(!0),h(U,null,D(t.ref_files,i=>(f(),h("a",{class:"filesItem",title:i.name,href:i.url,target:"_blank"},E(i.name),9,Fe))),256))],2)])):X("",!0)],2),[[N,!t.fold]])],2))),256)),T(o("div",ze,[n[16]||(n[16]=o("div",{class:"quesTitle"},"继续提问：",-1)),o("div",Ge,[(f(!0),h(U,null,D(a.value.rel_ques,t=>(f(),h("div",{class:"quesItem buttonEffect",title:t,onClick:s=>F(t)},E(t),9,He))),256))])],512),[[N,a.value.rel_ques.length>0]])],2)],2),o("div",{class:c(["requestArea",{hasContent:a.value.messages.length>0||a.value.status=="unload"}])},[o("div",{class:c(["request",g(w).type])},[T(o("textarea",{contenteditable:"true",class:c(["requestbox",g(w).type]),"onUpdate:modelValue":n[7]||(n[7]=t=>a.value.input=t),placeholder:"输入问题，多行输入使用Shift+Enter换行",onKeydown:we(ie(ee,["exact"]),["enter"]),onInput:n[8]||(n[8]=t=>F()),ref_key:"inputTextarea",ref:q},null,42,Je),[[pe,a.value.input]]),o("div",{class:c(["submitRow",g(w).type])},[o("img",{class:c(["submit",{buttonEffect:!Y.value,disable:Y.value}]),src:be,alt:"提问",onClick:ee},null,2)],2)],2)],2)])])}}},Ke=ce(Ve,[["__scopeId","data-v-156cab7d"]]);export{Ke as default};
