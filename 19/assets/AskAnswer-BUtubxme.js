import{_ as Ee,g as Y,r as M,e as N,f as ce,w as be,h as f,i as Ce,o as u,c,a as o,u as h,t as S,F as O,j as F,n as m,k as w,v as A,l as he,m as j,p as Se,q as me,s as Ae,d as Te,b as Be,x as z,y as Ie,z as qe,A as Me}from"./index-CcUAXEOT.js";const Z=""+new URL("../icon/del.svg",import.meta.url).href,Re=""+new URL("../icon/add.svg",import.meta.url).href,ve=""+new URL("../icon/chat.svg",import.meta.url).href,$e=""+new URL("../icon/edit.svg",import.meta.url).href,Le=""+new URL("../icon/loading.svg",import.meta.url).href,Ue=""+new URL("../icon/copy.svg",import.meta.url).href,Ne=""+new URL("../icon/submit.svg",import.meta.url).href,je={class:"area"},De={class:"functions"},Oe=["title"],Fe={class:"chats"},ze=["title","onClick"],Ge=["onBlur","onKeyup"],He=["onClick"],Ve={class:"mainArea"},Je={class:"questionBar"},Xe=["title","onClick"],Ke={xmlns:"http://www.w3.org/2000/svg","xml:space":"preserve",viewBox:"0 0 1964 1963",overflow:"hidden"},Pe=["id"],Qe={fill:"#393C45"},Ye=["title"],Ze=["onClick"],We=["onClick"],et={key:1},tt={key:2,class:"refFiles"},st=["onClick"],nt=["title","href"],lt={class:"relQues"},it={class:"quesItems"},ot=["title","onClick"],at=["onKeydown"],rt={__name:"AskAnswer",setup(ut){let p=Y().proxy.api,x=Y().proxy.config,y=Y().proxy.screen;const W=Blob&&URL.createObjectURL&&URL.revokeObjectURL,a=M(),d=N([]);let k=null;const R=M(),I=M(),ee=M();window.currentChat=a;const te=ce(()=>a.value.messages.every(l=>l.fold)),_=M(!1),G=M(!1);let H=null,se=null;window.addEventListener("mouseup",()=>G.value=!1),be(d,()=>{_.value=d.length<=0?!1:_.value});const ne=ce(()=>{const l=a.value;if(l.status!="ready")return!0;const e=l.messages;return e.length>0&&e[e.length-1].status=="unfinished"});window.chats=d;let T=()=>({Authorization:"Bearer "+x.loginStatus.userinfo.access_token,"Content-Type":"application/json"});function V(){const l=d.map(t=>t.session_id);function e(){let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(i){let r=(t+Math.random()*16)%16|0;return t=Math.floor(t/16),(i=="x"?r:r&3|8).toString(16)})}let s=e();for(;l.indexOf(s)>=0;)s=e();return k=N({title:"",messages:[],session_id:s,input:"",rel_ques:[],status:"ready",editing:!1}),k}f.on("loadChats",()=>{ae()}),f.on("clearChats",()=>{d.length=0,a.value=V()}),f.on("delAllChats",()=>{ge(!0)}),a.value=V();function le(){d.sort((l,e)=>e.timestamp-l.timestamp)}function ie(l,e=!0){if(a.value=l,l.status=="unload"){let s=function(n){n.forEach(i=>{l.messages.push(N({question:i.question,id:i.question_id,text:i.answer,status:"finished",controller:{abort(){}},fold:!1,ref_files:[],ref_show:!1}))}),l.status="ready",setTimeout(()=>I.value.scrollTo(0,Number.MAX_SAFE_INTEGER),300)},t=T();fetch(p.path+"/get_qas?session_id="+l.session_id,{method:"GET",headers:t}).then(n=>n.json()).then(n=>{if(n.code===401){f.emit("refreshToken",{onSuccess(i){t.Authorization="Bearer "+i,fetch(p.path+"/get_qas?session_id="+l.session_id,{method:"GET",headers:t}).then(r=>r.json()).then(r=>{if(r.code!==200)throw Error(r.code?r.message:"会话加载失败");s(r.data)}).catch(r=>{f.emit("dialog",{text:r.message}),console.error(r)})}});return}else if(n.code!==200)throw Error(n.code?n.message:"会话加载失败");s(n.data)}).catch(n=>{f.emit("dialog",{text:n.message}),console.error(n)})}y.type=="ver"&&e&&(_.value=!1),setTimeout(()=>I.value.scrollTo(0,Number.MAX_SAFE_INTEGER),300)}function oe(l,e=!1){function s(){let t=d.indexOf(l);d[t]==a.value&&(a.value=k),l.messages.forEach(n=>{n.controller.abort()}),d.splice(t,1),fetch(p.path+"/delete_session/"+l.session_id,{method:"DELETE",headers:T()})}e&&x.settings.comfBefDelSess?f.emit("dialog",{text:"确定删除该会话吗？",onYes(t){x.settings.comfBefDelSess=t,s()},checkText:"每次删除都提示确认",checkVal:!0}):s()}function ge(l=!1){function e(){fetch(p.path+"/delete_all_sessions",{method:"DELETE",headers:T()}),d.length=0,a.value=k}l?f.emit("dialog",{text:"确定清空所有会话吗？",onYes(){e()}}):e()}function ae(){function l(s){let t=!1,n=[];if(d.length=0,s.forEach(i=>{d.push({title:i.name,session_id:i.session_id,timestamp:i.timestamp,messages:[],rel_ques:[],input:"",status:"unload",editing:!1}),n.push(i.session_id),i.session_id==k.session_id&&(t=!0)}),t){let i=function(){let v=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){let q=(v+Math.random()*16)%16|0;return v=Math.floor(v/16),(b=="x"?q:q&3|8).toString(16)})},r=i();for(;n.indexOf(r)>=0;)r=i();k.session_id=r}a.value=k}if(!x.loginStatus.isLogged)return;let e=T();fetch(p.path+"/get_sessions",{method:"GET",headers:e}).then(s=>s.json()).then(s=>{if(s.code===401)f.emit("refreshToken",{onSuccess(t){e.Authorization="Bearer "+t,fetch(p.path+"/get_sessions",{method:"GET",headers:e}).then(n=>n.json()).then(n=>{if(n.code!==200)throw Error(n.code?n.message:"会话加载失败，请刷新重试");l(n.data||[])}).catch(n=>{f.emit("dialog",{text:n.message}),console.error(n)})}});else{if(s.code!==200)throw Error(s.code?s.message:"会话加载失败，请刷新重试");l(s.data||[])}}).catch(s=>{f.emit("dialog",{text:s.message}),console.error(s)})}let B=N("");function J(l,e=void 0){e!==void 0?(l.editing=!1,e&&l.title!=e&&(l.title=e,fetch(p.path+"/rename"),console.log("发送rename请求",e))):(B=l.title,l.editing=!0,Me(()=>{se.getElementsByClassName("input")[0].focus()}))}function pe(l,e){let s=l.target,t=s.getClientRects()[0],n=ee.value;n.style.top="",n.style.left="",n.style.bottom="",n.style.right="",y.type=="hor"?(n.style.top=t.bottom+"px",n.style.left=t.left+"px"):(n.style.top=t.top+"px",n.style.right=`calc(100% - ${t.right}px)`),H=e,se=s.parentElement,G.value=!0}function X(l=void 0){l!=null&&(a.value.input=l,R.value.value=l),R.value.style.height="auto",R.value.style.height=R.value.scrollHeight+"px"}async function re(l){l.preventDefault();const e=a.value,s=e.messages;s.length>0&&s[s.length-1].status=="unfinished"||await K(e.input)&&(X(""),e.rel_ques.length=0)}async function K(l,e=void 0,s=a.value){if(!x.loginStatus.isLogged)return f.emit("startLogin",{msg:"请登录后使用",err:!0}),!1;if(l=l.trim(),l.length<=0)return!1;let t=T();if(d.indexOf(s)<0){s.title=l,s.timestamp=new Date().getTime().toFixed(),s.status="prepost";try{let g=JSON.stringify({session_id:s.session_id,name:s.title}),C=await fetch(p.path+"/add_session",{method:"POST",headers:t,body:g});if(C=await C.json(),C.code===401)return f.emit("refreshToken",{onSuccess(){K(l,void 0,s)},onFail(){s.status="ready"}}),!0;if(C.code!==201)throw Error(C.code?C.message:"会话创建失败，请刷新重试")}catch(g){return f.emit("dialog",{text:g.message}),console.error(g),s.status="ready",!1}s.status="ready",d.push(s),le(),V()}let n=N({question:l,id:null,text:"",status:"unfinished",controller:new AbortController,fold:!1,ref_files:[],ref_show:!1}),i="";e?ue(s,e,n):s.messages.push(n);let r=[];r.push({role:"user",content:l}),fetch(p.path+"/v1/chat/completions",{signal:n.controller.signal,method:"POST",headers:t,body:JSON.stringify({session_id:s.session_id,model:"qwen2.5-math-7b-instruct",messages:r,max_tokens:1e3,temperature:x.settings.temperature})}).then(g=>{if(g.status===401){f.emit("refreshToken",{onSuccess(){K(l,n,s)},onFail(){i="[登录过期，请重新登录]",n.status="error"}});return}else if(!g.ok)throw Error(g.status+": "+g.statusText);const C=g.body.getReader(),we=new TextDecoder;let $="";function fe(){C.read().then(({done:D,value:ke})=>{if(D){n.status="finished";return}$+=we.decode(ke,{stream:!0});let Q=0,L=0;for(;L=$.indexOf("}",Q)+1,L!=0;)try{let U=JSON.parse($.substring(0,L));if(n.id=U.id,U.final){s.timestamp=U.created,le(),console.log(U),n.status="finished",xe(n,s);return}i+=U.choices[0].message.content,$=$.substring(L),Q=0}catch{Q=L}fe()}).catch(D=>{if(D.name==="AbortError"){i="",n.status="finished";return}i+="[解析异常]",n.status="error",console.error(D)})}fe()}).catch(g=>{if(g.name==="AbortError"){i="",n.status="finished";return}i+="[请求异常]",n.status="error",console.error(g)});let v=0,E=0,b=0,q="",P=0;return x.settings.printByWord?(E=setInterval(()=>{if(v==1&&setTimeout(()=>I.value.scrollTo(0,Number.MAX_SAFE_INTEGER),500),v<i.length)q+=i.at(v),++v;else if(n.status!="unfinished"){if(v<i.length){P=0;return}else if(P<5){P++;return}clearInterval(E),n.text=q,clearInterval(b)}},1e3/x.settings.charPerSecond),b=setInterval(()=>{n.text=q},1e3/20)):b=setInterval(()=>{n.text=i,v==1&&i.length>0&&setTimeout(()=>I.value.scrollTo(0,Number.MAX_SAFE_INTEGER),500),v++,n.status!="unfinished"&&(n.text=i,clearInterval(b))},1e3/20),!0}function xe(l,e=a.value){fetch(p.path+"/v1/related_questions",{signal:l.controller.signal,method:"POST",headers:T(),body:JSON.stringify({question:l.question})}).then(s=>{if(s.status!=200)throw Error(s.status+": "+s.statusText);return s.json()}).then(s=>{s.status=="success"&&(e.rel_ques=s.related_questions||[],setTimeout(()=>I.value.scrollTo(0,Number.MAX_SAFE_INTEGER),500))}).catch(s=>{console.error(s)}),fetch(p.path+"/v1/reference_files?question_id="+l.id,{signal:l.controller.signal,method:"GET",headers:{Authorization:"Bearer "+x.loginStatus.userinfo.access_token}}).then(s=>{if(s.status!=200)throw Error(s.status+": "+s.statusText);return s.json()}).then(s=>{s.status=="success"&&(l.ref_files=s.reference_files)}).catch(s=>{console.error(s)})}function ue(l,e,s=void 0,t=!1){function n(i,r,v=void 0){r.controller.abort();let E=i.messages.indexOf(r);if(v)i.messages.splice(E,1,v);else{if(i.messages.length==1){oe(i);return}if(r.status!="error"){let b=JSON.stringify({session_id:i.session_id,question_id:i.messages[E].id});fetch(p.path+"/delete_qa",{method:"DELETE",body:b,headers:T()})}i.messages.splice(E,1)}return E}t&&x.settings.comfBefDelQues&&e.status!="error"?f.emit("dialog",{text:"确认要删除该轮提问？",onYes(i){x.settings.comfBefDelQues=i,n(l,e,s)},checkText:"每次删除都提示确认",checkVal:!0}):n(l,e,s)}function _e(){te.value?a.value.messages.forEach(l=>{l.fold=!1}):a.value.messages.forEach(l=>{l.fold=!0})}async function ye(l){l&&(await navigator.clipboard.writeText(l),f.emit("dialog",{text:"复制成功"}))}function de(l,e){if(l.messages.length<=0)return;let s=null,t="";if(e==="markdown")t=".md",s="",l.messages.forEach(n=>{n.status=="finished"&&(s+=`**${n.question}**

`,s+=n.text+`

`,n.ref_files.length>0&&(s+="`参考文档`\n\n",n.ref_files.forEach(i=>{s+=`#### [*${i.name}*](${i.url})

`})),s+=`---

`)});else if(e==="json"){t=".json";let n=l.messages.filter(r=>r.status=="finished").map(r=>({question:r.question,question_id:r.id,answer:r.text,timestamp:r.timestamp,reference_files:r.ref_files})),i={name:l.title,session_id:l.session_id,questions:n};s=JSON.stringify(i)}if(s){let n=document.createElement("a");s=new Blob([s]);let i=URL.createObjectURL(s);n.href=i,n.download=`${l.session_id}${t}`,n.click(),URL.revokeObjectURL(i)}}return ae(),(l,e)=>{const s=Ce("Markdown");return u(),c("div",je,[o("div",{class:m(["chatsBar",h(y).type,{show:d.length>0,active:_.value}])},[o("div",De,[h(y).type=="hor"?(u(),c("div",{key:0,class:"toggleBar buttonEffect",onClick:e[0]||(e[0]=t=>_.value=!_.value),title:_.value?"收回":"展开"},S(_.value?"<":">"),9,Oe)):(u(),c("div",{key:1,class:"toggleBar buttonEffect",onClick:e[1]||(e[1]=t=>_.value=!1),title:"关闭"},e[13]||(e[13]=[o("img",{src:Z,alt:" X"},null,-1)]))),o("div",{class:"addButton buttonEffect",onClick:e[2]||(e[2]=t=>ie(h(k))),title:"创建新会话"},e[14]||(e[14]=[o("img",{src:Re,alt:"add"},null,-1),o("div",null,"创建新会话",-1)]))]),o("div",Fe,[(u(!0),c(O,null,F(d,t=>(u(),c("div",{key:t.timestamp,class:m(["chatItem",{buttonEffect:!t.editing,active:a.value==t}]),title:t.title,onClick:n=>ie(t)},[e[15]||(e[15]=o("img",{src:ve,alt:"C",class:"chatIcon"},null,-1)),w(o("span",{class:"text"},S(t.title),513),[[A,!t.editing]]),w(o("input",{type:"text",class:"input",onClick:e[3]||(e[3]=j(()=>{},["stop"])),"onUpdate:modelValue":e[4]||(e[4]=n=>Se(B)?B.value=n:B=n),onBlur:n=>J(t,h(B)),onKeyup:me(n=>J(t,h(B)),["enter"])},null,40,Ge),[[A,t.editing],[he,h(B)]]),w(o("img",{src:Ae,alt:"...",class:"menuButton buttonEffect",onClick:j(n=>pe(n,t),["stop"]),title:"会话设置"},null,8,He),[[A,!t.editing]])],10,ze))),128)),w(o("div",{class:"chatMenu",ref_key:"chatMenu",ref:ee},[o("div",{class:"chatMenuItem buttonEffect",onClick:e[5]||(e[5]=j(t=>J(h(H),void 0),["stop"])),title:"重命名"},e[16]||(e[16]=[o("img",{src:$e,alt:"",class:"icon"},null,-1),o("span",{class:"text"},"重命名",-1)])),o("div",{class:"chatMenuItem buttonEffect",onClick:e[6]||(e[6]=j(t=>oe(h(H),!0),["stop"])),title:"删除会话"},e[17]||(e[17]=[o("img",{src:Z,alt:"",class:"icon"},null,-1),o("span",{class:"text"},"删除会话",-1)]))],512),[[A,G.value]])])],2),w(o("img",{src:ve,alt:"对话",class:"floatChat buttonEffect",onClick:e[7]||(e[7]=t=>_.value=!_.value)},null,512),[[A,h(y).type=="ver"&&d.length>0]]),o("div",Ve,[o("div",{class:m(["loading",{show:a.value.status=="unload"}])},e[18]||(e[18]=[o("img",{class:"autoInvert",src:Le,alt:""},null,-1),Te(" 加载中 ")]),2),o("div",{class:m(["startArea",{hasContent:a.value.messages.length>0||a.value.status=="unload"}])},e[19]||(e[19]=[o("div",{class:"title"},[o("img",{src:Be,alt:"MathSolve"}),o("span",null,"你的数学解题助手")],-1),o("div",{class:"subtitle"},"一键求解，轻松解决你的数学烦恼",-1)]),2),o("div",{class:m(["answersArea",{hasContent:a.value.messages.length>0||a.value.status=="unload"}])},[o("div",{class:m(["toolbar",h(y).type])},[h(W)?(u(),c("div",{key:0,onClick:e[8]||(e[8]=t=>de(a.value,"markdown")),class:"buttonEffect"},"导出会话.md")):z("",!0),h(W)?(u(),c("div",{key:1,onClick:e[9]||(e[9]=t=>de(a.value,"json")),class:"buttonEffect"},"导出会话.json")):z("",!0),o("div",{onClick:e[10]||(e[10]=t=>_e()),class:"buttonEffect"},"全部"+S(te.value?"展开":"折叠"),1)],2),o("div",{class:m(["answers",h(y).type]),ref_key:"answers",ref:I},[(u(!0),c(O,null,F(a.value.messages,(t,n)=>(u(),c("div",{class:m(["msg",t.status])},[o("div",Je,[o("div",{class:m(["foldButton","buttonEffect",{folded:t.fold}]),title:t.fold?"展开":"折叠",onClick:i=>t.fold=!t.fold},[(u(),c("svg",Ke,[o("defs",null,[o("mask",{id:"mask"+n},e[20]||(e[20]=[o("rect",{width:"100%",height:"100%",fill:"white"},null,-1),o("path",{class:"turn",stroke:"black","stroke-linejoin":"round","stroke-miterlimit":"10","stroke-width":"150",d:"m982 926 632 791h-319l-313-391-313 391H350Z"},null,-1)]),8,Pe)]),o("g",Qe,[o("path",{d:"M287 1174h1390v203H287zM287 786h1390v203H287zM287 398h1390v203H287z",style:Ie(`mask:url(#mask${n})`)},null,4),e[21]||(e[21]=o("path",{class:"turn",d:"m982 982 562 702h-284l-278-347-278 347H420Z"},null,-1))])]))],10,Xe),o("div",{class:m(["question",{folded:t.fold,thinking:t.fold&&t.status==="unfinished"}]),title:t.question},S(t.question),11,Ye),t.status=="finished"?(u(),c("img",{key:0,class:"questionBarButton buttonEffect",src:Ue,title:"复制答案为markdown",style:{"margin-right":"15px"},onClick:i=>ye(t.text)},null,8,Ze)):z("",!0),o("img",{class:"questionBarButton buttonEffect",src:Z,title:"删除",onClick:i=>ue(a.value,t,void 0,!0)},null,8,We)]),w(o("br",null,null,512),[[A,!t.fold]]),w(o("div",{class:m({foldable:!0,thinking:t.status==="unfinished"}),style:{display:"flex"}},[t.text.length>0?(u(),qe(s,{key:0,md:t.text,theme:h(x).settings.theme},null,8,["md","theme"])):(u(),c("div",et," ... ")),t.ref_files.length>0?(u(),c("div",tt,[o("div",{class:"filesTitle buttonEffect",onClick:i=>t.ref_show=!t.ref_show},S(t.ref_show?"∧":"∨")+" 参考文档 "+S(t.ref_show?"∧":"∨"),9,st),o("div",{class:m(["filesItems",{show:t.ref_show}])},[(u(!0),c(O,null,F(t.ref_files,i=>(u(),c("a",{class:"filesItem",title:i.name,href:i.url,target:"_blank"},S(i.name),9,nt))),256))],2)])):z("",!0)],2),[[A,!t.fold]])],2))),256)),w(o("div",lt,[e[22]||(e[22]=o("div",{class:"quesTitle"},"继续提问：",-1)),o("div",it,[(u(!0),c(O,null,F(a.value.rel_ques,t=>(u(),c("div",{class:"quesItem buttonEffect",title:t,onClick:n=>X(t)},S(t),9,ot))),256))])],512),[[A,a.value.rel_ques.length>0]])],2)],2),o("div",{class:m(["requestArea",{hasContent:a.value.messages.length>0||a.value.status=="unload"}])},[o("div",{class:m(["request",h(y).type])},[w(o("textarea",{class:m(["requestbox",h(y).type]),"onUpdate:modelValue":e[11]||(e[11]=t=>a.value.input=t),placeholder:"输入问题，多行输入使用Shift+Enter换行",onKeydown:me(j(re,["exact"]),["enter"]),onInput:e[12]||(e[12]=t=>X()),ref_key:"inputTextarea",ref:R},null,42,at),[[he,a.value.input]]),o("div",{class:m(["submitRow",h(y).type])},[o("img",{class:m(["submit",{buttonEffect:!ne.value,disable:ne.value}]),src:Ne,alt:"提问",onClick:re},null,2)],2)],2)],2)])])}}},ft=Ee(rt,[["__scopeId","data-v-1cd3031c"]]);export{ft as default};
